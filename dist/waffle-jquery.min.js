!function(t,n,r){!function(n){"function"==typeof define&&define.amd?define(["jquery"],n):"object"==typeof exports?module.exports=n(require("jquery")):t.Waffle=n(jQuery)}(function(t){"use strict";var e=function(){var t=Array.prototype,n=t.slice,i=Object.prototype,o=Object.keys,s=i.hasOwnProperty,a=i.toString,u=Function.prototype.bind,h=function(t){return e.isString(t)?function(n){return n[t]}:t},c=function(t){return function(n,r,e){for(var i={},o=h(r),s=0,a=n.length;a>s;++s){var u=o.call(e,n[s],s,n);t(i,n[s],u)}return i}};return{isNull:function(t){return null===t},isBoolean:function(t){return t===!0||t===!1||"[object Boolean]"===a.call(t)},bind:function(t,n){return u?t.bind(n):function(){return t.apply(n,arguments)}},toArray:function(t){return e.map(t,function(t){return t})},defaults:function(t,n){return e.forEach(e.keys(n),function(r){e.isUndefined(t[r])&&(t[r]=n[r])}),t},result:function(t,n){var r=t[n];return e.isFunction(r)?r.call(t):r},has:function(t,n){return s.call(t,n)},size:function(t){return t.length},first:function(t,r){return null==r?t[0]:n.call(t,0,r)},last:function(t,r){return null==r?t[t.length-1]:n.call(t,t.length-r,t.length)},rest:function(t,r){var e=arguments.length>1?r:1;return n.call(t,e,t.length)},initial:function(t,r){var e=t.length,i=arguments.length>1?e-r:e-1;return n.call(t,0,i)},indexOf:function(t,n){for(var r=0,e=t.length;e>r;++r)if(t[r]===n)return r;return-1},lastIndexOf:function(t,n){for(var r=t.length-1;r>=0;--r)if(t[r]===n)return r;return-1},keys:function(t){if(!e.isObject(t))return[];if(o)return o(t);var n=[];for(var r in t)e.has(t,r)&&n.push(r);return n},functions:function(t){var n=[];for(var r in t)e.isFunction(t[r])&&n.push(r);return n.sort()},map:function(t,n,r){for(var e=[],i=0,o=t.length;o>i;++i)e[i]=n.call(r,t[i],i,t);return e},every:function(t,n,r){for(var e=0,i=t.length;i>e;++e)if(!n.call(r,t[e],e,t))return!1;return!0},some:function(t,n,r){for(var e=0,i=t.length;i>e;++e)if(n.call(r,t[e],e,t))return!0;return!1},filter:function(t,n,r){for(var e=[],i=0,o=t.length;o>i;++i)n.call(r,t[i],i,t)&&e.push(t[i]);return e},reject:function(t,n,r){for(var e=[],i=0,o=t.length;o>i;++i)n.call(r,t[i],i,t)||e.push(t[i]);return e},reduce:function(t,n,r){for(var e=arguments.length,i=3===e?r:t[0],o=t.length,s=3===e?0:1;o>s;++s)i=n.call(null,i,t[s],s,t);return i},reduceRight:function(t,n,r){for(var e=arguments.length,i=t.length-1,o=3===e?r:t[i],s=3===e?i:i-1;s>=0;--s)o=n.call(null,o,t[s],s,t);return o},find:function(t,n,e){for(var i=0,o=t.length;o>i;++i)if(n.call(e,t[i],i,t))return t[i];return r},partition:function(t,n){for(var r=[],e=[],i=0,o=t.length;o>i;++i)n.call(null,t[i],i,t)?r.push(t[i]):e.push(t[i]);return[r,e]},memoize:function(t,n){var r=function(i){var o=r.cache,s=n?n.apply(this,arguments):i;return e.has(o,s)||(o[s]=t.apply(this,arguments)),o[s]};return r.cache={},r},indexBy:c(function(t,n,r){t[r]=n}),groupBy:c(function(t,n,r){(t[r]=t[r]||[]).push(n)}),countBy:c(function(t,n,r){t[r]=(t[r]||0)+1})}}();!function(){var t=Object.prototype.toString;e.noop=function(){},e.identity=function(t){return t},e.isUndefined=function(t){return"undefined"==typeof t},e.isObject=function(t){var n=typeof t;return"function"===n||"object"===n&&!!t},e.isElement=function(t){return!(!t||1!==t.nodeType)},e.clone=function(t){for(var n=[],r=0,e=t.length;e>r;++r)n[r]=t[r];return n},e.forEach=function(t,n,r){for(var e=0,i=t.length;i>e;++e)n.call(r,t[e],e,t)},e.forEach(["String","Function","Number","Date","Array"],function(n){e["is"+n]=function(r){return t.call(r)==="[object "+n+"]"}}),Array.isArray&&(e.isArray=Array.isArray)}();var i=function(t){var n=i.$split(t),o=n.length;return function(t){for(var i=t,s=0;o>s;++s){if(null==i||!e.isObject(i))return r;i=e.result(i,n[s])}return i}};i.$normalize=function(t){for(var n=[],r=t.split("."),e=/(.+?)?(\[(\d+)\])/,i=/(.+?)?(\['(.+)'\])/,o=/(.+?)?(\["(.+)"\])/,s=function(t,n,r,e){var i=n?n+".":"";return i+e},a=0,u=r.length;u>a;++a){var h=r[a].replace(e,s).replace(i,s).replace(o,s),c=h.indexOf("(");c>0&&(h=h.slice(0,c)),n[a]=h}return n.join(".")},i.$split=function(t){return i.$normalize(t).split(".")};var o=function(t){var r=n.createElement("div");return r.appendChild(n.createTextNode(t)),r.innerHTML},s="waffle-",a=s+"sortable",u=a+"-asc",h=a+"-desc",c=s+"fixedheader",l="data-waffle-",f=l+"id",d=l+"sortable",p=l+"order",$="+",v="-",y=function(){var t="key_",n=function(n){return t+n},r=function(){return this instanceof r?void(this.$o={}):new r};return r.prototype={clear:function(){this.$o={}},put:function(t,r){return this.$o[n(t)]=r,this},get:function(t){return this.$o[n(t)]},remove:function(t){return delete this.$o[n(t)],this},contains:function(t){return e.has(this.$o,n(t))}},r}(),g=function(){var t=function(){var t=n.createElement("div");t.style.width="100px",t.style.height="100px",t.style.overflow="scroll",t.style.position="absolute",t.style.top="-9999px",n.body.appendChild(t);var r=t.offsetWidth-t.clientWidth;return n.body.removeChild(t),r},r=function(){return"body"},i={create:function(t){return n.createElement(t)},byId:function(t){var r=n.getElementById(t);return r?[r]:[]},byTagName:function(t,r){return(r||n).getElementsByTagName(t)},createFragment:function(){return n.createDocumentFragment()},scrollbarWidth:e.memoize(t,r)};return e.forEach(["tr","td","th","tbody","thead"],function(t){i[t]=function(){return this.create(t)}}),i}(),m={toPx:function(t){return e.isNumber(t)?t+"px":t},fromPx:function(t){return e.isString(t)?Number(t.replace("px","")):t}},b=function(){var t=Array.prototype,n=function(){try{var n={};return n[0]=1,!!t.toString.call(n)}catch(r){return!1}}(),o=function(r){return function(){var i=n?this:e.toArray(this);return t[r].apply(i,arguments)}},s=function(t,n,r){return o(t).apply(n,r)},a=function(t,n){this.$$map=new y;var r=n||{};this.$$key=r.key||"id",this.$$model=r.model||Object,e.isFunction(this.$$key)||(this.$$key=i(this.$$key)),this.$$observers=[],this.$$changes=[],this.length=0,t&&t.length&&this.push.apply(this,t)},u=function(t){return parseInt(Number(t)||0,10)},h="splice",c="update",l=function(t,n,r,e,i){return{type:t,removed:n,index:r,addedCount:e,object:i}},f=function(t,n){delete t[n]},d=function(t,n){t.$$map.remove(n)},p=function(t,n){var r=t.$$key(n),e=t.$$map.get(r);null!=e&&(f(t,e),d(t,r))},$=function(t,n){if(!e.isObject(n))throw new Error("Waffle collections are not array, only object are allowed");return n instanceof t.$$model?n:new t.$$model(n)},v=function(t,n,r){t[r]=n,null!=n&&t.$$map.put(t.$$key(n),r)},g=function(t,n,r){var e=t.at(r),i=t.at(n);v(t,i,r),v(t,e,n)},m=function(t,n,r){for(var e=Math.abs(r),i=t.length-1;i>=n;--i)g(t,i,i+e);t.length+=e},b=function(t,n,r){for(var e=Math.abs(r),i=t.length,o=i-e,s=n+e,a=[],u=s;i>u;++u)g(t,u,u-e);for(var h=o;i>h;++h){var c=t.at(h);a.unshift(c),p(t,c)}return t.length=o,a},w=function(t,n){for(var r,i=t.$$sortFn,o=t.length,s=n.length,a=o+s,u=[],c=o-1,f=s-1,d=a-1;d>=0;--d)if(0>c||i(t[c],n[f])<0){if(v(t,n[f--],d),r=e.first(u),r&&r.index===d+1?(r.index=d,r.addedCount++):(r=l(h,[],d,1,t),u.unshift(r)),0>f)break}else v(t,t[c--],d);return t.length=a,u},x=function(t){t.callback.call(t.ctx,this.$$changes)};return a.prototype={at:function(t){return this[t]},byKey:function(t){var n=this.indexByKey(t);return n>=0?this.at(n):r},indexByKey:function(t){return this.$$map.contains(t)?this.$$map.get(t):-1},findIndex:function(t,n){for(var r=0,e=this.length;e>r;++r)if(t.call(n,this.at(r),r,this))return r;return-1},add:function(t,n){var r=[t,0].concat(n);return this.splice.apply(this,r),this.length},remove:function(t,n){return this.splice.call(this,t,n)},push:function(){return this.add.call(this,this.length,e.toArray(arguments))},unshift:function(){return this.add.call(this,0,e.toArray(arguments))},pop:function(){return this.remove(this.length-1,1)[0]},shift:function(){return this.remove(0,1)[0]},clear:function(){if(this.length>0){for(var t=[],n=0,r=this.length;r>n;++n)t[n]=this.at(n),f(this,n);this.$$map.clear(),this.length=0,this.trigger(l(h,t,0,0,this))}return this},reset:function(t){var n=this.length,r=t.length,e=this.$$sortFn;e&&t.sort(e),this.$$map.clear();for(var i=[],o=t.length,s=0;r>s;++s)n>s&&i.push(this.at(s)),v(this,$(this,t[s]),s);for(;n>s;++s)i.push(this.at(s)),f(this,s);return this.length=r,this.trigger([l(h,i,0,o,this)]),this},isEmpty:function(){return 0===this.length},concat:function(){var n=t.concat.apply(this.toArray(),arguments);return new a(n,{key:this.$$key,model:this.$$model})},slice:function(){var t=s("slice",this,arguments);return new a(t,{key:this.$$key,model:this.$$model})},splice:function(t,n){var r=this.$$sortFn,i=this.length,o=e.rest(arguments,2),s=function(t){return $(this,t)},a=e.map(o,s,this),c=a.length,f=u(t);f=f>=0?Math.min(i,f):Math.max(i+f,0);var d=Math.min(Math.max(u(n)||0,0),i-f),p=[];if(d>0){for(var y=0;d>y;++y)p.push(this[y+f]);b(this,f,d)}var g;if(c>0)if(r)a.sort(r),g=w(this,a);else{m(this,f,c);for(var x=0;c>x;++x)v(this,a[x],f+x);g=[l(h,p,f,c,this)]}else g=[];if(p.length>0){var A=e.find(g,function(t){return t.index===f});A?A.removed=p:g.unshift(l(h,p,f,0,this))}return g&&g.length>0&&this.trigger(g),p},reverse:function(){if(this.$$sortFn)return this;for(var t=this.length,n=Math.floor(t/2),r=[],e=[],i=0,o=t-1;n>i;++i,--o)g(this,i,o),r.push(l(c,[],i,0,this)),e.unshift(l(c,[],o,0,this));var s=r.concat(e);return s.length&&this.trigger(s),this},split:function(t){for(var n=t||20,r=[],e=[],i=0,o=this.length;o>i;++i)e.push(this.at(i)),e.length===n&&(r.push(e),e=[]);return e.length>0&&r.push(e),r},toJSON:function(){return JSON.stringify(this.toArray())},sort:function(t){return this.$$sortFn=t,this.reset(this.toArray()).clearChanges()},pluck:function(t){return this.map(i(t))},observe:function(t,n){return this.$$observers.push({ctx:n||null,callback:t}),this},unobserve:function(t,n){if(0===arguments.length)this.$$observers=[];else{var r=n||null;this.$$observers=e.reject(this.$$observers,function(n){return n.ctx===r&&t===n.callback})}return this},trigger:function(t){this.$$changes=this.$$changes.concat(t);var n=this;return setTimeout(function(){n.$$changes.length>0&&(e.forEach(n.$$observers,x,n),n.$$changes=[]),n=null}),this},clearChanges:function(){return this.$$changes=[],this}},e.forEach(["indexOf","size","lastIndexOf","first","last","initial","rest","partition","forEach","map","every","some","reduce","reduceRight","filter","reject","find","toArray"],function(t){e[t]&&(a.prototype[t]=function(){var n=[this].concat(e.toArray(arguments));return e[t].apply(e,n)})}),e.forEach(["countBy","groupBy","indexBy"],function(t){a.prototype[t]=function(n,r){return e.isString(n)&&(n=i(n)),e[t].call(e,this,n,r)}}),e.forEach(["toString","toLocaleString","join"],function(t){a.prototype[t]=o(t)}),a}(),w=function(){var t=function(t){return(null==t?"":t).toString()},n={$identity:e.identity,$empty:function(){return""},$lowercase:function(n){return t(n).toLowerCase()},$uppercase:function(n){return t(n).toUpperCase()},$capitalize:function(n){var r=t(n);return r.charAt(0).toUpperCase()+r.slice(1)},$get:function(t){return n[t]}};return n}(),x={$string:function(t,n){var r=null==t?"":String(t),e=null==n?"":String(n);return r.localeCompare(e)},$number:function(t,n){var r=null==t?0:Number(t),e=null==n?0:Number(n);return r-e},$boolean:function(t,n){var r="false"===t?0:Boolean(t)?1:0,e="false"===n?0:Boolean(n)?1:0;return r-e},$date:function(t,n){var r=new Date(null==t?0:t).getTime(),e=new Date(null==n?0:n).getTime();return r-e},$auto:function(t,n){if(t===n||null==t&&null==n)return 0;var r=e.find(["Number","Boolean","Date","String"],function(r){var i=e["is"+r];return i(t)||i(n)});return r?x["$"+r.toLowerCase()](t,n):n>t?-1:1},$get:function(t){return x[t]}},A=function(t){return e.isArray(t)||(t=[t]),function(n,r){if(n===r||null==n&&null==r)return 0;for(var e=0,i=t.length;i>e;++e){var o=t[e],s=o.parser(n),a=o.parser(r),u=o.fn.call(x,s,a);if(u)return o.desc?-1*u:u}return 0}},B=function(){var t=e.isUndefined,n="$identity",r="$auto",s=m.fromPx,c=m.toPx,l=function(t,n,r){return e.isString(t)&&(t=n.$get(t)),e.isFunction(t)||(t=n.$get(r)),t},y=function(a){var u=a.escape,h=a.sortable;this.id=a.id,this.title=a.title||"",this.field=a.field||this.id,this.css=a.css||this.id,this.escape=t(u)?!0:!!u,this.width=s(a.width),this.sortable=t(h)?!0:!!h,this.asc=t(a.asc)?null:!!a.asc,u&&(this.title=o(this.title));var c=a.renderer||n,f=e.isArray(c)?c:[c];this.$renderer=e.map(f,function(t){return l(t,w,n)}),this.$comparator=l(a.comparator,x,r),this.$parser=i(this.field)};return y.prototype={cssClasses:function(){var t=[this.css];this.sortable&&t.push(a);var n=this.asc;return null!=n&&t.push(n?u:h),t.join(" ")},attributes:function(t,n){var r={};if(r[f]=this.id,n&&this.sortable){r[d]=!0;var e=this.asc;null!=e&&(r[p]=e?$:v)}return r},styles:function(){var t={},n=c(this.width);return n&&(t.width=n,t.maxWidth=n,t.minWidth=n),t},updateWidth:function(t){return this.width=s(t),this},render:function(t){var n=this.field,r=null==t?"":this.$parser(t),i=e.reduce(this.$renderer,function(r,e){return e.call(w,r,t,n)},r);return null==i?"":this.escape?o(i):i}},y}(),C=function(){var n=m.toPx,r=m.fromPx,o=function(t){var n=t||[];return e.isArray(n)||(n=[n]),e.map(n,function(t){var n=t.charAt(0);return n!==$&&n!==v?$+t:t})},s=function(t,n,r){var i=t.options.events[n];return i!==e.noop&&i.apply(t,(r||e.noop).call(t)),t},a=function(n){var r=n.$table[0];if(n.$tbody=t(g.byTagName("tbody",r)),n.$thead=t(g.byTagName("thead",r)),!n.$thead.length){var e=g.thead();n.$thead=t(e),n.$table.append(e)}if(!n.$tbody.length){var i=g.tbody();n.$tbody=t(i),n.$table.append(i)}return n},l=function(n,r){var e=g.tr();return n.$columns.forEach(function(n,i){var o=t(g.td()).addClass(n.cssClasses(i,!1)).css(n.styles(i,!1)).attr(n.attributes(i,!1)).html(n.render(r));e.appendChild(o[0])}),e},y=function(n,i){if(!(this instanceof y))return new y(n,i);e.defaults(i.events||{},y.options.events),this.options=e.defaults(i||{},y.options),this.$table=t(n),this.$data=new b(i.data||[],{key:i.key}),this.$columns=new b(i.columns||[],{key:"id",model:B});var o=i.size;this.options.size={width:r(o.width),height:r(o.height)},this.$sortBy=[],a(this),this.$$bind().$$observe().assignWidth().renderHeader().sortBy(i.sortBy,!1).renderBody(),s(this,"onInitialized")};return y.create=function(t,n){return new y(t,n)},y.prototype={data:function(){return this.$data},columns:function(){return this.$columns},render:function(){return this.renderHeader().renderBody()},assignWidth:function(){var t=this.options.size,r=t.width;if(t.height){var e=n(t.width);this.$table.addClass(c).css({width:e,maxWidth:e,minWidth:e}),this.$tbody.css({maxHeight:n(t.height)}),r-=g.scrollbarWidth()}var i=0,o=0;this.$columns.forEach(function(t){var n=t.width;n&&(i+=n,++o)});var s=this.$columns.length,a=s-o,u=0,h=0;if(a){var l=(r-i)/a;u=Math.floor(l),h=l-u}var f=0;return this.$columns.forEach(function(t){var n=t.width,r=n||0;r||(f+=h,f>=1?(r=u+1,f--):r=u),r!==n&&t.updateWidth(r)}),this},renderHeader:function(){var n=g.tr();return this.$columns.forEach(function(r,e,i){var o=t(g.th()).addClass(r.cssClasses(e,!0)).css(r.styles(e,!0)).attr(r.attributes(e,i,!0)).html(r.title);n.appendChild(o[0])}),this.$thead.empty().append(n),this},renderBody:function(t){var n=null==t?this.options.async:t,r=this,i=function(t,n){for(var r=g.createFragment(),e=0,i=n.length;i>e;++e){var o=l(t,n[e]);r.appendChild(o)}return r},o=function(t){t.$data.clearChanges(),s(t,"onRendered",function(){return[this.$data,e.toArray(this.$tbody[0].childNodes)]}),t=i=o=null};if(n){var a=10,u=this.$data.split(200),h=function(){if(u.length>0){var t=i(r,u.shift());r.$tbody.append(t),setTimeout(h,a)}else o(r),h=u=null};this.$tbody.empty(),setTimeout(h)}else{var c=i(r,r.data());r.$tbody.empty().append(c),o(r)}return this},sortBy:function(t,n){var r=o(t);if(this.$sortBy===r||this.$sortBy.join()===r.join())return this;this.$sortBy=r;var a=this.$thead.children().eq(0),c=a.children();c.removeClass(u+" "+h).removeAttr(p);var l=this.$columns,f=e.map(this.$sortBy,function(t){var n,r=t.charAt(0),e=t.substr(1),o=r===$,s=l.indexByKey(e);return s>=0?(n=l.at(s),n.asc=o,c.eq(s).addClass(o?u:h).attr(p,r)):n={},{parser:n.$parser||i(t),fn:n.$comparator||x.$auto,desc:!o}});return this.$data.sort(A(f)),n!==!1&&this.renderBody(),s(this,"onSorted")},destroy:function(){return this.$$unbind().$$unobserve().$$destroy()},$$destroy:function(){for(var t in this)this.hasOwnProperty(t)&&(this[t]=null);return this},$$bind:function(){var t=this;return this.$thead.on("click",function(n){var r=n.target;if(r.getAttribute(d)){var e,i=r.getAttribute(f),o=r.getAttribute(p)||v,s=o===$?v:$,a=s+i;if(n.shiftKey){e=t.$sortBy.slice();var u=o+i,h=e.indexOf(u);h>=0&&e.splice(h,1),e.push(a)}else e=[a];t.sortBy(e)}}),this},$$unbind:function(){return this.$thead.off(),this},$$observe:function(){return this.$data.observe(this.$$onDataChange,this),this},$$unobserve:function(){return this.$data.unobserve(),this},$$onDataChange:function(t){return e.forEach(t,function(t){var n=t.type,r="$$on_"+n;this[r](t)},this),this},$$on_splice:function(t){var n=t.index,r=t.addedCount,i=t.object,o=t.removed.length;if(o>0){var a;if(0===n&&o===this.$tbody[0].childNodes.length)a=e.toArray(this.$tbody[0].childNodes),this.$tbody.empty();else{a=[];for(var u=0;o>u;++u){var h=u+n,c=this.$tbody.children().eq(h);a.push(c[0]),c.remove()}}s(this,"onRemoved",function(){return[t.removed,a,n]})}if(r>0){for(var f=g.createFragment(),d=[],p=[],$=0;r>$;++$){var v=$+n,y=i.at(v),m=l(this,y);p.push(m),d.push(y),f.appendChild(m)}n>0?this.$tbody.children().eq(n-1).after(f):this.$tbody.prepend(f),s(this,"onAdded",function(){return[d,p,n]})}return this},$$on_update:function(t){var n=t.index,r=this.$data.at(n),e=this.$tbody[0],i=e.childNodes[n],o=l(this,r);return e.replaceChild(o,i),this}},y.options={key:"id",async:!1,size:{width:null,height:null},events:{}},e.forEach(["onInitialized","onRendered","onAdded","onRemoved","onSorted"],function(t){y.options.events[t]=e.noop}),y}(),j={Grid:C,addRenderer:function(t,n){return w[t]=n,j},addComparator:function(t,n){return x[t]=n,j}},k="wafflejs";t.fn.waffle=function(n){var r=this,i=[r].concat(e.rest(arguments));return e.isUndefined(n)||e.isObject(n)?this.each(function(){var r=t(this),i=r.data(k);if(!i){var o=t.extend({},t.fn.waffle.options);e.isObject(n)&&(o=t.extend(o,n)),i=new C(this,o),r.data(k,i),r.on("waffleDestroyed",function(){var n=t(this);n.data(k).destroy(),n.removeData(k).off()})}}):e.isString(n)&&(r=t.fn.waffle[n].apply(null,i)||r),r},t.fn.waffle.options={},t.event.special.waffleDestroyed={add:function(t){t.handler&&(t.handler=e.bind(t.handler,this))},remove:function(t){t.handler&&t.handler(t)}};var E=e.filter(e.functions(C.prototype),function(t){return"$"!==t.charAt(0)});return e.forEach(E,function(n){t.fn.waffle[n]=function(r){var i=e.rest(arguments),o=[];return r.each(function(){var e=t(this),s=e.data(k);if(s){var a=s[n].apply(s,i),u=a instanceof C?r:a;u===r?o[0]=u:o.push(u)}}),1===o.length?o[0]:o}}),e.forEach(e.functions(j),function(n){t.fn.waffle[n]=j[n]}),t.fn.waffle.options=C.options,j})}(window,document,void 0);