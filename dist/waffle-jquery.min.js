!function(t,e,n){!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):"object"==typeof exports?module.exports=e(require("jquery")):t.Waffle=e(jQuery)}(function(t){"use strict";var r=function(){var t=Array.prototype,e=t.slice,r=Object.prototype,i=Object.keys,o=r.hasOwnProperty,s=r.toString,a=Function.prototype.bind,u=function(t){return h.isString(t)?function(e){return e[t]}:t},c=function(t){return function(e,n,r){for(var i={},o=u(n),s=0,a=e.length;a>s;++s){var c=o.call(r,e[s],s,e);t(i,e[s],c)}return i}},h={};return h.isNull=function(t){return null===t},h.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"===s.call(t)},h.bind=function(t,e){return a?t.bind(e):function(){return t.apply(e,arguments)}},h.toArray=function(t){return h.map(t,function(t){return t})},h.once=function(t){var e,n=!1;return function(){return n||(n=!0,e=t.apply(this,arguments),t=null),e}},h.defaults=function(t,e){return h.forEach(h.keys(e),function(n){h.isUndefined(t[n])&&(t[n]=e[n])}),t},h.result=function(t,e){var n=t[e];return h.isFunction(n)?n.call(t):n},h.has=function(t,e){return o.call(t,e)},h.size=function(t){return t.length},h.first=function(t,n){return null==n?t[0]:e.call(t,0,n)},h.last=function(t,n){return null==n?t[t.length-1]:e.call(t,t.length-n,t.length)},h.rest=function(t,n){var r=arguments.length>1?n:1;return e.call(t,r,t.length)},h.initial=function(t,n){var r=t.length,i=arguments.length>1?r-n:r-1;return e.call(t,0,i)},h.indexOf=function(t,e){for(var n=0,r=t.length;r>n;++n)if(t[n]===e)return n;return-1},h.lastIndexOf=function(t,e){for(var n=t.length-1;n>=0;--n)if(t[n]===e)return n;return-1},h.contains=function(t,e){return h.indexOf(t,e)>=0},h.keys=function(t){if(!h.isObject(t))return[];if(i)return i(t);var e=[];for(var n in t)h.has(t,n)&&e.push(n);return e},h.functions=function(t){var e=[];for(var n in t)h.isFunction(t[n])&&e.push(n);return e.sort()},h.map=function(t,e,n){for(var r=[],i=0,o=t.length;o>i;++i)r[i]=e.call(n,t[i],i,t);return r},h.every=function(t,e,n){for(var r=0,i=t.length;i>r;++r)if(!e.call(n,t[r],r,t))return!1;return!0},h.some=function(t,e,n){for(var r=0,i=t.length;i>r;++r)if(e.call(n,t[r],r,t))return!0;return!1},h.filter=function(t,e,n){for(var r=[],i=0,o=t.length;o>i;++i)e.call(n,t[i],i,t)&&r.push(t[i]);return r},h.reject=function(t,e,n){for(var r=[],i=0,o=t.length;o>i;++i)e.call(n,t[i],i,t)||r.push(t[i]);return r},h.reduce=function(t,e,n){for(var r=arguments.length,i=3===r?n:t[0],o=t.length,s=3===r?0:1;o>s;++s)i=e.call(null,i,t[s],s,t);return i},h.reduceRight=function(t,e,n){for(var r=arguments.length,i=t.length-1,o=3===r?n:t[i],s=3===r?i:i-1;s>=0;--s)o=e.call(null,o,t[s],s,t);return o},h.find=function(t,e,r){for(var i=0,o=t.length;o>i;++i)if(e.call(r,t[i],i,t))return t[i];return n},h.partition=function(t,e){for(var n=[],r=[],i=0,o=t.length;o>i;++i)e.call(null,t[i],i,t)?n.push(t[i]):r.push(t[i]);return[n,r]},h.memoize=function(t,e){var n=function(r){var i=n.cache,o=e?e.apply(this,arguments):r;return h.has(i,o)||(i[o]=t.apply(this,arguments)),i[o]};return n.cache={},n},h.now=Date.now||function(){return(new Date).getTime()},h.indexBy=c(function(t,e,n){t[n]=e}),h.groupBy=c(function(t,e,n){(t[n]=t[n]||[]).push(e)}),h.countBy=c(function(t,e,n){t[n]=(t[n]||0)+1}),h}();!function(){var t=Object.prototype.toString;r.noop=function(){},r.identity=function(t){return t},r.isUndefined=function(t){return"undefined"==typeof t},r.isObject=function(t){var e=typeof t;return"function"===e||"object"===e&&!!t},r.isElement=function(t){return!(!t||1!==t.nodeType)},r.clone=function(t){for(var e=[],n=0,r=t.length;r>n;++n)e[n]=t[n];return e},r.forEach=function(t,e,n){for(var r=0,i=t.length;i>r;++r)e.call(n,t[r],r,t)},r.extend=function(t,e){for(var n in e)r.has(e,n)&&(t[n]=e[n]);return t},r.forEach(["String","Function","Number","Date","Array"],function(e){r["is"+e]=function(n){return t.call(n)==="[object "+e+"]"}}),Array.isArray&&(r.isArray=Array.isArray)}();var i=function(t){var e=i.$split(t),o=e.length;return function(t){for(var i=t,s=0;o>s;++s){if(null==i||!r.isObject(i))return n;i=r.result(i,e[s])}return i}};i.$normalize=function(t){for(var e=[],n=t.split("."),r=/(.+?)?(\[(\d+)\])/,i=/(.+?)?(\['(.+)'\])/,o=/(.+?)?(\["(.+)"\])/,s=function(t,e,n,r){var i=e?e+".":"";return i+r},a=0,u=n.length;u>a;++a){var c=n[a].replace(r,s).replace(i,s).replace(o,s),h=c.indexOf("(");h>0&&(c=c.slice(0,h)),e[a]=c}return e.join(".")},i.$split=function(t){return i.$normalize(t).split(".")};var o=function(t){var n=e.createElement("div");return n.appendChild(e.createTextNode(t)),n.innerHTML},s="waffle-",a="waffle-grid",u=s+"sortable",c=u+"-asc",h=u+"-desc",l=s+"fixedheader",f=s+"selectable",d=s+"selected",p=s+"checkbox",v="data-waffle-",$=v+"id",g=v+"sortable",y=v+"order",m=v+"idx",b="+",C="-",x=function(){var t="key_",e=function(e){return t+e},n=function(){return this instanceof n?void(this.$o={}):new n};return n.prototype={clear:function(){this.$o={}},put:function(t,n){return this.$o[e(t)]=n,this},get:function(t){return this.$o[e(t)]},remove:function(t){return delete this.$o[e(t)],this},contains:function(t){return r.has(this.$o,e(t))}},n}(),w={toPx:function(t){return r.isNumber(t)?t+"px":t},fromPx:function(t){return r.isString(t)?Number(t.replace("px","")):t},capitalize:function(t){return t.charAt(0).toUpperCase()+t.slice(1)},destroy:function(t){for(var e in t)r.has(t,e)&&(t[e]=null)},asyncTask:function(t,e,n,r){var i=0,o=function(){if(t.length>0){var s=t.shift();n(s,i),i+=s.length,t.length>0?setTimeout(o,e):(r(),o=null)}};setTimeout(o)}},k=function(){var t=function(){var t=e.createElement("div");t.style.width="100px",t.style.height="100px",t.style.overflow="scroll",t.style.position="absolute",t.style.top="-9999px",e.body.appendChild(t);var n=t.offsetWidth-t.clientWidth;return e.body.removeChild(t),n},n=function(){return"body"},i={create:function(t){return e.createElement(t)},byId:function(t){var n=e.getElementById(t);return n?[n]:[]},byTagName:function(t,n){return(n||e).getElementsByTagName(t)},createFragment:function(){return e.createDocumentFragment()},findParent:function(t,e){for(;t&&t.tagName!==e;)t=t.parentNode;return t},updateAttributes:function(t,e){var n=t.attributes,i=e.attributes;r.forEach(i,function(e,r){var o=n[r].value,s=i[r].value;o!==s&&t.setAttribute(e.name,s)})},updateClassName:function(t,e){var n=t.className,r=e.className;n!==r&&(t.className=e.className)},updateContent:function(t,e){var n=t.innerHTML,r=e.innerHTML;n!==r&&(t.innerHTML=r)},scrollbarWidth:r.memoize(t,n)};return r.forEach(["tr","td","th","tbody","thead","tfoot","input","span"],function(t){i[t]=function(){return this.create(t)}}),r.forEach(["text","checkbox"],function(t){var e="input"+w.capitalize(t);i[e]=function(){var e=this.input();return e.setAttribute("type",t),e}}),i}(),E=function(){var t=r.noop,e=function(t,e,n){this.type=t,this.bubbles=!1,this.cancelable=!1,this.details=n,this.target=e,this.currentTarget=e,this.timeStamp=r.now()};e.prototype={preventDefault:t,stopPropagation:t,stopImmediatePropagation:t};var n=function(t){return t.toLowerCase()},i=function(){this.$events={}};return i.prototype={addEventListener:function(t,e){var r=n(t),i=this.$events,o=i[r]=i[r]||[];o.push(e)},removeEventListener:function(t,e){var i=n(t),o=this.$events[i];o&&o.length&&(this.$events[i]=r.reject(o,function(t){return t===e}))},dispatchEvent:function(t,i,o){i=n(i);var s=this.$events[i];if(s&&s.length)for(var a=new e(i,t,r.isFunction(o)?o.call(t):o),u=0,c=s.length;c>u;++u)try{s[u].call(t,a)}catch(h){}},clear:function(){this.$events={}}},i}(),N=function(){var t=function(t){return t&&t.length>0},e=function(t){t.callback.call(t.ctx,this.$$changes)},n=function(){var n=this.$$changes,i=this.$$observers;t(n)&&t(i)&&r.forEach(i,e,this),this.clearChanges()},i={observe:function(t,e){return this.$$observers=this.$$observers||[],this.$$observers.push({ctx:e||null,callback:t}),this},unobserve:function(e,n){if(t(this.$$observers))if(0===arguments.length)this.$$observers=[];else{var i=n||null;this.$$observers=r.reject(this.$$observers,function(t){return t.ctx===i&&e===t.callback})}return this},trigger:function(t){return this.$$changes=(this.$$changes||[]).concat(t),setTimeout(r.bind(n,this)),this},clearChanges:function(){return this.$$changes=[],this}};return i}(),A=function(){var t=Array.prototype,e=function(){try{var e={};return e[0]=1,!!t.toString.call(e)}catch(n){return!1}}(),o=function(n){return function(){var i=e?this:r.toArray(this);return t[n].apply(i,arguments)}},s=function(t,e,n){return o(t).apply(e,n)},a=function(t,e){var n=e||{};this.$$map=new x,this.$$model=n.model||Object,this.$$key=n.key||"id",r.isFunction(this.$$key)||(this.$$key=i(this.$$key)),this.length=0,t&&t.length&&this.push.apply(this,t)},u=function(t){return parseInt(Number(t)||0,10)},c="splice",h="update",l=function(t,e,n,r,i){return{type:t,removed:e,index:n,addedCount:r,object:i}},f=function(t,e){delete t[e]},d=function(t,e){t.$$map.remove(e)},p=function(t,e){var n=t.$$key(e),r=t.$$map.get(n),i=r?r.idx:null;null!=i&&(f(t,i),d(t,n))},v=function(t,e){if(!r.isObject(e))throw new Error("Waffle collections are not array, only object are allowed");return e instanceof t.$$model?e:new t.$$model(e)},$=function(t,e,n,r){if(t[n]=e,null!=e){var i=arguments.length,o=3===i?t.$$key(e):r,s=t.$$map.get(o)||{};s.idx=n,t.$$map.put(o,s)}},g=function(t,e){var n=t.indexOf(e);return t[n]=e,l(h,[],n,0,t)},y=function(t,e,n){var r=t.at(n),i=t.at(e);$(t,i,n),$(t,r,e)},m=function(t,e,n){for(var r=Math.abs(n),i=t.length-1;i>=e;--i)y(t,i,i+r);t.length+=r},b=function(t,e,n){for(var r=Math.abs(n),i=t.length,o=i-r,s=e+r,a=[],u=s;i>u;++u)y(t,u,u-r);for(var c=o;i>c;++c){var h=t.at(c);a.unshift(h),p(t,h)}return t.length=o,a},C=function(t,e){for(var n,i=t.$$sortFn,o=t.length,s=e.length,a=o+s,u=[],h=o-1,f=s-1,d=a-1;d>=0;--d)if(0>h||i(t[h],e[f])<0){if($(t,e[f--],d),n=r.first(u),n&&n.index===d+1?(n.index=d,n.addedCount++):(n=l(c,[],d,1,t),u.unshift(n)),0>f)break}else $(t,t[h--],d);return t.length=a,u};return a.prototype={options:function(){return{model:this.$$model,key:this.$$key}},at:function(t){return this[t]},byKey:function(t){var e=this.indexOf(t);return e>=0?this.at(e):n},indexOf:function(t){var e=r.isObject(t)?this.$$key(t):t;return this.$$map.contains(e)?this.$$map.get(e).idx:-1},contains:function(t){return this.indexOf(t)>=0},findIndex:function(t,e){for(var n=0,r=this.length;r>n;++n)if(t.call(e,this.at(n),n,this))return n;return-1},add:function(t,e){var n=null==e?this.length:e,r=[n,0].concat(t);return this.splice.apply(this,r),this.length},remove:function(t,e){if(r.isNumber(t))return this.splice.call(this,t,e||this.length);if(r.isArray(t)){var n=this.$$key,i=r.indexBy(t,n);return this.remove(function(t){return!!i[n(t)]})}for(var o=t,s=e,a=0,u=null,h=[],p=[],v=0,g=this.length;g>v;++v){var y=this.at(v),m=this.$$key(y);o.call(s,y,v)?(f(this,v),d(this,m),u===v-1?r.last(h).removed.push(y):h.push(l(c,[y],v,0,this)),p.push(y),u=v):(a!==v&&(f(this,v),d(this,m),$(this,y,a,m)),a++)}return this.length-=p.length,h.length>0&&this.trigger(h),p},replace:function(t){var e=[0,0].concat(t);return this.splice.apply(this,e),this},push:function(){return this.add.call(this,r.toArray(arguments))},unshift:function(){return this.add.call(this,r.toArray(arguments),0)},pop:function(){return this.remove(this.length-1,1)[0]},shift:function(){return this.remove(0,1)[0]},toggle:function(t){var e=this.indexOf(t);return e>=0?this.remove(e,1):this.push(t)},clear:function(){if(this.length>0){for(var t=[],e=0,n=this.length;n>e;++e)t[e]=this.at(e),f(this,e);this.$$map.clear(),this.length=0,this.trigger(l(c,t,0,0,this))}return this},reset:function(t){var e=this.length,n=t.length,r=this.$$sortFn;r&&t.sort(r),this.$$map.clear();for(var i=[],o=t.length,s=0;n>s;++s)e>s&&i.push(this.at(s)),$(this,v(this,t[s]),s);for(;e>s;++s)i.push(this.at(s)),f(this,s);return this.length=n,this.trigger([l(c,i,0,o,this)]),this},isEmpty:function(){return 0===this.length},concat:function(){var e=t.concat.apply(this.toArray(),arguments);return new a(e,this.options())},slice:function(){var t=s("slice",this,arguments);return new a(t,this.options())},splice:function(t,e){var n=this.$$sortFn,i=this.length,o=r.rest(arguments,2),s=function(t){return v(this,t)},a=r.map(o,s,this),h=u(t);h=h>=0?Math.min(i,h):Math.max(i+h,0);var f=Math.min(Math.max(u(e)||0,0),i-h),d=[];if(f>0){for(var p=0;f>p;++p)d.push(this[p+h]);b(this,h,f)}var y,x=r.groupBy(a,this.contains,this),w=x[!0]||[],k=x[!1]||[],E=k.length,N=w.length;if(E>0)if(n)k.sort(n),y=C(this,k);else{m(this,h,E);for(var A=0;E>A;++A)$(this,k[A],h+A);y=[l(c,d,h,E,this)]}else y=[];if(d.length>0){var S=r.find(y,function(t){return t.index===h});S?S.removed=d:y.unshift(l(c,d,h,0,this))}var j=[];if(N>0){n&&w.sort(n);for(var O=0;N>O;++O)j.push(g(this,w[O]))}var T=y.concat(j);return T.length>0&&this.trigger(T),d},reverse:function(){if(this.$$sortFn)return this;for(var t=this.length,e=Math.floor(t/2),n=[],r=[],i=0,o=t-1;e>i;++i,--o)y(this,i,o),n.push(l(h,[],i,0,this)),r.unshift(l(h,[],o,0,this));var s=n.concat(r);return s.length&&this.trigger(s),this},split:function(t){for(var e=t||20,n=[],r=[],i=0,o=this.length;o>i;++i)r.push(this.at(i)),r.length===e&&(n.push(r),r=[]);return r.length>0&&n.push(r),n},toJSON:function(){return JSON.stringify(this.toArray())},sort:function(t){return this.$$sortFn=t,this.reset(this.toArray()).clearChanges()},pluck:function(t){return this.map(i(t))}},a.prototype.lastIndexOf=a.prototype.indexOf,r.extend(a.prototype,N),r.forEach(["size","first","last","initial","rest","partition","forEach","map","every","some","reduce","reduceRight","filter","reject","find","toArray"],function(t){r[t]&&(a.prototype[t]=function(){var e=[this].concat(r.toArray(arguments));return r[t].apply(r,e)})}),r.forEach(["countBy","groupBy","indexBy"],function(t){a.prototype[t]=function(e,n){return r.isString(e)&&(e=i(e)),r[t].call(r,this,e,n)}}),r.forEach(["toString","toLocaleString","join"],function(t){a.prototype[t]=o(t)}),a}(),S=function(){var t=function(t){return(null==t?"":t).toString()},e={$identity:r.identity,$empty:function(){return""},$lowercase:function(e){return t(e).toLowerCase()},$uppercase:function(e){return t(e).toUpperCase()},$capitalize:function(e){return w.capitalize(t(e))},$get:function(t){return e[t]}};return e}(),j={$string:function(t,e){var n=null==t?"":String(t),r=null==e?"":String(e);return n.localeCompare(r)},$number:function(t,e){var n=null==t?0:Number(t),r=null==e?0:Number(e);return n-r},$boolean:function(t,e){var n="false"===t?0:Boolean(t)?1:0,r="false"===e?0:Boolean(e)?1:0;return n-r},$date:function(t,e){var n=new Date(null==t?0:t).getTime(),r=new Date(null==e?0:e).getTime();return n-r},$auto:function(t,e){if(t===e||null==t&&null==e)return 0;var n=r.find(["Number","Boolean","Date","String"],function(n){var i=r["is"+n];return i(t)||i(e)});return n?j["$"+n.toLowerCase()](t,e):e>t?-1:1},$get:function(t){return j[t]}},O=function(t){return r.isArray(t)||(t=[t]),function(e,n){if(e===n||null==e&&null==n)return 0;for(var r=0,i=t.length;i>r;++r){var o=t[r],s=o.parser(e),a=o.parser(n),u=o.fn.call(j,s,a);if(u)return o.desc?-1*u:u}return 0}},T=function(){var t={".":"-","(":"",")":"","[":"-","]":"-","'":"",'"':""},e=r.isUndefined,n="$identity",s="$auto",a=w.fromPx,l=w.toPx,f=function(t,e,n){return r.isString(t)&&(t=e.$get(t)),r.isFunction(t)||(t=e.$get(n)),t},d=function(u){var c=u.escape,h=u.sortable;if(this.id=u.id,this.title=u.title||"",this.field=u.field||this.id,this.css=u.css||"",this.escape=e(c)?!0:!!c,this.width=a(u.width),this.sortable=e(h)?!0:!!h,this.asc=e(u.asc)?null:!!u.asc,!this.css)for(var l=0,d=this.id.length;d>l;++l){var p=this.id.charAt(l),v=t[p];this.css+=null!=v?v:p}c&&(this.title=o(this.title));var $=u.renderer||n,g=r.isArray($)?$:[$];this.$renderer=r.map(g,function(t){return f(t,S,n)}),this.$comparator=f(u.comparator,j,s),this.$parser=i(this.field)};return d.prototype={cssClasses:function(){var t=[this.css];this.sortable&&t.push(u);var e=this.asc;return null!=e&&t.push(e?c:h),t.join(" ")},attributes:function(t,e){var n={};if(n[$]=this.id,e&&this.sortable){n[g]=!0;var r=this.asc;null!=r&&(n[y]=r?b:C)}return n},styles:function(){var t={},e=l(this.width);return e&&(t.width=e,t.maxWidth=e,t.minWidth=e),t},updateWidth:function(t){return this.width=a(t),this},render:function(t){var e=this.field,n=null==t?"":this.$parser(t),i=r.reduce(this.$renderer,function(n,r){return r.call(S,n,t,e)},n);return null==i?"":this.escape?o(i):i}},d}(),B={theadRow:function(t){var e=k.tr();return t.hasCheckbox()&&e.appendChild(B.theadCheckboxCell(t)),t.$columns.forEach(function(n,r){e.appendChild(B.theadCell(t,n,r))}),e},theadCell:function(e,n,r){return t(k.th()).addClass(n.cssClasses(r,!0)).css(n.styles(r,!0)).attr(n.attributes(r,!0)).html(n.title)[0]},theadCheckboxCell:function(e){var n=e.$selection.size(),r=e.$data.size(),i=t(k.span()).attr("title",n).html(n),o=t(k.inputCheckbox()).prop("checked",e.isSelected()).prop("indeterminate",n>0&&n!==r);return t(k.th()).addClass(p).append(i[0]).append(o[0])[0]},tfootRow:function(t){var e=k.tr();return t.hasCheckbox()&&e.appendChild(B.tfootCheckboxCell(t)),t.$columns.forEach(function(n,r){e.appendChild(B.tfootCell(t,n,r))}),e},tfootCell:function(t,e,n){return B.theadCell(t,e,n)},tfootCheckboxCell:function(t){var e=B.theadCheckboxCell(t);return e.appendChild(e.childNodes[0]),e},tbodyRows:function(t,e,n){for(var r=k.createFragment(),i=0,o=e.length;o>i;++i)r.appendChild(B.tbodyRow(t,e[i],n+i));return r},tbodyRow:function(e,n,r){var i=t(k.tr());return i.attr(m,r),e.isSelectable()&&e.$selection.contains(n)&&i.addClass(d),e.hasCheckbox()&&i[0].appendChild(B.tbodyCheckboxCell(e,n)),e.$columns.forEach(function(t,r){i[0].appendChild(B.tbodyCell(e,n,t,r))}),i[0]},tbodyCell:function(e,n,r,i){return t(k.td()).addClass(r.cssClasses(i,!1)).css(r.styles(i,!1)).attr(r.attributes(i,!1)).html(r.render(n))[0]},tbodyCheckboxCell:function(e,n){var r=t(k.inputCheckbox()).prop("checked",e.isSelected(n));return t(k.td()).addClass(p).append(r[0])[0]}},z=function(){var t="THEAD",e="TFOOT",n="TBODY",i="TH",o="TR",s="INPUT",a=function(t){return t.tagName===s&&"checkbox"===t.getAttribute("type")},u=function(t,e){var n=t.target,o=k.findParent(t.target,i);if(n.tagName!==e)if(this.isSelectable()&&a(n))n.checked?this.select():this.deselect();else if(o&&o.getAttribute(g)){var s,u=o.getAttribute($),c=o.getAttribute(y)||C,h=c===b?C:b,l=h+u;if(t.shiftKey){var f=c+u;s=r.reject(this.$sortBy,function(t){return t===f})}else s=[];s.push(l),this.sortBy(s)}},c={onClickThead:function(e){return u.call(this,e,t)},onClickTfoot:function(t){return u.call(this,t,e)},onClickTbody:function(t){if(this.isSelectable()&&t.target.tagName!==n){var e=k.findParent(t.target,o),r=e.getAttribute(m),i=this.$data.at(r),s=this.$selection;if(this.options.selection.multi)if(t.shiftKey){for(var a=parseFloat(r),u=parseFloat(this.$$selectAnchor),c=Math.min(a,u),h=Math.max(a,u),l=[],f=c;h>=f;++f){var d=this.$data.at(f);s.contains(d)||l.push(d)}l.length>0&&s.push.apply(s,l)}else s.toggle(i),this.$$selectAnchor=r;else{var p=s.indexOf(i);p>=0?s.remove(p,1):s.reset([i])}}}};return c}(),F={on:function(t,e){return r.forEach(e,function(e){var n="on"+w.capitalize(e.type);F[n].call(F,t,e)}),this},onSplice:function(t,e){var n,i,o,s=t.$tbody,a=s[0],u=a.childNodes,c=e.index,h=e.addedCount,l=e.object,f=e.removed,d=f.length;if(d>0){if(0===c&&d===u.length)n=r.toArray(u),s.empty();else{n=[];for(var p=0;d>p;++p)n.push(a.removeChild(u[c]))}var v=t.$selection;v&&v.length>0&&v.remove(f)}if(h>0){i=[],o=[];for(var $=k.createFragment(),g=0;h>g;++g){var y=g+c,b=l.at(y),C=B.tbodyRow(t,b,y);i.push(C),o.push(b),$.appendChild(C)}c>0?s.children().eq(c-1).after($):s.prepend($)}if(n||i){for(var x=c+h,w=u.length;w>x;++x)u[x].setAttribute(m,x);t.dispatchEvent("dataspliced",{added:o||[],addedNodes:i||[],removedNodes:n||[],removed:f,index:c})}return this},onUpdate:function(t,e){var n=e.index,i=t.$data.at(n),o=t.$tbody[0],s=o.childNodes[n],a=B.tbodyRow(t,i,n);k.updateAttributes(s,a),k.updateClassName(s,a);var u=s.childNodes,c=a.childNodes;return r.forEach(c,function(t,e){var n=u[e];k.updateAttributes(n,t),k.updateClassName(n,t),k.updateContent(n,t)}),t.dispatchEvent("dataupdated",{updatedNode:s}),this}},L=function(){var e=function(t){return t.childNodes[0].childNodes[0]},n=function(t,e){t.checked=e},i={on:function(t,e){return r.forEach(e,function(e){var n="on"+w.capitalize(e.type),r=L[n];r&&r.call(L,t,e)}),this},onSplice:function(r,i){var o,s,a=r.$tbody,u=r.$data,c=i.object,h=a[0],l=h.childNodes,f=i.index,p=i.removed,v=i.addedCount,$=p.length;if($>0)for(var g=0;$>g;++g)o=u.indexOf(p[g]),o>=0&&(s=l[o],t(s).removeClass(d),r.hasCheckbox()&&n(e(s),!1));if(v>0)for(var y=0;v>y;++y)o=u.indexOf(c.at(f+y)),s=l[o],t(s).addClass(d),r.hasCheckbox()&&n(e(s),!0);if(v>0||$>0){var m=v-$;if(m&&r.hasCheckbox()){var b=c.length,C=r.$thead[0],x=r.$tfoot[0],w=C.childNodes[0].childNodes[0],k=w.childNodes[0],E=w.childNodes[1],N=x.childNodes[0].childNodes[0],A=N.childNodes[1],S=N.childNodes[0];A.innerHTML=k.innerHTML=b,A.title=k.title=b,S.checked=E.checked=r.isSelected(),S.indeterminate=E.indeterminate=b>0&&u.length!==b}r.dispatchEvent("selectionchanged",function(){return{selection:this.$selection.toArray()}})}return this}};return i}(),M=function(){var e=w.toPx,n=w.fromPx,o=function(t){var e=t||[];return r.isArray(e)||(e=[e]),r.map(e,function(t){var e=t.charAt(0);return e!==b&&e!==C?b+t:t})},s=function(e){var n="$"+e,r=this.$table;this[n]=t(k.byTagName(e,r[0])),this[n].length||(this[n]=t(k[e]())),r.append(this[n][0])},u=function(t){return F.on(this,t)},d=function(t){return L.on(this,t)},p=function(t){var e=this.options.events[t];e&&this.addEventListener(t.slice(2),this.options.events[t])},v=function(e,i){if(!(this instanceof v))return new v(e,i);var o=i=i||{},c=v.options;r.forEach(["events","selection","size"],function(t){var e=o[t];(r.isObject(e)||r.isUndefined(e))&&(o[t]=r.defaults(e||{},c[t]))}),this.options=r.defaults(o,c),o.size={width:n(o.size.width),height:n(o.size.height)},o.scrollable=o.scrollable||!!o.size.height;var h=this.isSelectable(),$=this.isSortable(),g=o.scrollable;this.$table=t(e),this.$data=new A(o.data,{key:o.key,model:o.model}),$||r.forEach(o.columns,function(t){t.sortable=!1}),this.$columns=new A(o.columns,{key:"id",model:T}),this.$sortBy=[],this.$table.addClass(a),h&&this.$table.addClass(f),g&&this.$table.addClass(l),r.forEach(["thead","tbody","tfoot"],s,this),(h||$)&&(this.$thead.on("click",r.bind(z.onClickThead,this)),this.$tfoot.on("click",r.bind(z.onClickTfoot,this))),this.$data.observe(u,this),h&&(this.$selection=new A([],this.$data.options()),this.$tbody.on("click",r.bind(z.onClickTbody,this)),this.$selection.observe(d,this)),this.$bus=new E,r.forEach(r.keys(o.events),p,this),(o.size.height||o.size.width)&&this.assignWidth(),this.renderHeader().renderFooter().sortBy(i.sortBy,!1).renderBody(),this.dispatchEvent("initialized")};return v.create=function(t,e){return new v(t,e)},v.prototype={data:function(){return this.$data},columns:function(){return this.$columns},selection:function(){return this.$selection},isSortable:function(){return this.options.sortable},isSelectable:function(){var t=this.options.selection;return t&&t.enable},hasCheckbox:function(){return this.isSelectable()&&this.options.selection.checkbox},isSelected:function(t){if(!this.isSelectable())return!1;if(t)return this.$selection.contains(t);var e=this.$data.length,n=this.$selection.length;return e>0&&e===n},render:function(){return this.renderHeader().renderFooter().renderBody()},assignWidth:function(){var t=this.options.size,n=t.width;if(t.height){var r=e(t.width);this.$table.css({width:r,maxWidth:r,minWidth:r}),this.$tbody.css({maxHeight:e(t.height)}),n-=k.scrollbarWidth(),this.hasCheckbox()&&(n-=30)}var i=0,o=0;this.$columns.forEach(function(t){var e=t.width;e&&(i+=e,++o)});var s=this.$columns.length,a=s-o,u=0,c=0;if(a){var h=(n-i)/a;u=Math.floor(h),c=h-u}var l=0;return this.$columns.forEach(function(t){var e=t.width,n=e||0;n||(l+=c,l>=1?(n=u+1,l--):n=u),n!==e&&t.updateWidth(n)}),this},renderHeader:function(){var t=B.theadRow(this);return this.$thead.empty().append(t),this},renderFooter:function(){var t=B.tfootRow(this);return this.$tfoot.empty().append(t),this},renderBody:function(t){var e=null==t?this.options.async:t,n=this,i=r.once(function(){n.$tbody.empty()}),o=function(t,e){var r=B.tbodyRows(n,t,e);i(),n.$tbody.append(r)},s=function(){n.$data.clearChanges(),n.dispatchEvent("rendered",function(){return{data:this.$data,nodes:r.toArray(this.$tbody[0].childNodes)}}),n=i=o=s=null};return e?w.asyncTask(this.$data.split(200),10,o,s):(o(this.$data,0),s()),this},select:function(){return this.$selection.length!==this.$data.length&&this.$selection.add(this.$data.toArray()),this},deselect:function(){return this.$selection.isEmpty()||this.$selection.clear(),this},sortBy:function(t,e){var n=o(t);if(this.$sortBy===n||this.$sortBy.join()===n.join())return this;this.$sortBy=n;var s=this.$thead.children().eq(0).children(),a=this.$tfoot.children().eq(0).children();s.removeClass(c+" "+h).removeAttr(y),a.removeClass(c+" "+h).removeAttr(y);var u=this.$columns,l=this.hasCheckbox(),f=r.map(this.$sortBy,function(t){var e,n=t.charAt(0),r=t.substr(1),o=n===b,f=u.indexOf(r),d=l?f+1:f;return f>=0?(e=u.at(f),e.asc=o,s.eq(d).addClass(o?c:h).attr(y,n),a.eq(d).addClass(o?c:h).attr(y,n)):e={},{parser:e.$parser||i(t),fn:e.$comparator||j.$auto,desc:!o}});return this.$data.sort(O(f)),e!==!1&&this.renderBody(),this.dispatchEvent("sorted")},dispatchEvent:function(t,e){return this.$bus.dispatchEvent(this,t,e),this},addEventListener:function(t,e){return this.$bus.addEventListener(t,e),this},removeEventListener:function(t,e){return this.$bus.removeEventListener(t,e),this},destroy:function(){this.$thead.off(),this.$tfoot.off(),this.$tbody.off(),this.$data.unobserve(),this.$selection.unobserve(),this.$bus.clear(),w.destroy(this)}},v.options={key:"id",async:!1,scrollable:!1,sortable:!0,selection:{enable:!0,checkbox:!0,multi:!1},size:{width:null,height:null},events:{}},r.forEach(["onInitialized","onRendered","onDataSpliced","onDataUpdated","onSelectionChanged","onSorted"],function(t){v.options.events[t]=null}),v}(),D={Grid:M,addRenderer:function(t,e){return S[t]=e,D},addComparator:function(t,e){return j[t]=e,D}},R="wafflejs";t.fn.waffle=function(e){var n=this,i=[n].concat(r.rest(arguments));return r.isUndefined(e)||r.isObject(e)?this.each(function(){var n=t(this),i=n.data(R);if(!i){var o=t.extend({},t.fn.waffle.options);r.isObject(e)&&(o=t.extend(o,e)),i=new M(this,o),n.data(R,i),n.on("waffleDestroyed",function(){var e=t(this);e.data(R).destroy(),e.removeData(R).off()})}}):r.isString(e)&&(n=t.fn.waffle[e].apply(null,i)||n),n},t.fn.waffle.options={},t.event.special.waffleDestroyed={add:function(t){t.handler&&(t.handler=r.bind(t.handler,this))},remove:function(t){t.handler&&t.handler(t)}};var W=r.filter(r.functions(M.prototype),function(t){return"$"!==t.charAt(0)});return r.forEach(W,function(e){t.fn.waffle[e]=function(n){var i=r.rest(arguments),o=[];return n.each(function(){var r=t(this),s=r.data(R);if(s){var a=s[e].apply(s,i),u=a instanceof M?n:a;u===n?o[0]=u:o.push(u)}}),1===o.length?o[0]:o}}),r.forEach(r.functions(D),function(e){t.fn.waffle[e]=D[e]}),t.fn.waffle.options=M.options,D})}(window,document,void 0);