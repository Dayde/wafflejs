!function(t,n,e){!function(n){"function"==typeof define&&define.amd?define(["underscore"],n):"object"==typeof exports?module.exports=n(require("underscore")):t.Waffle=n(_)}(function(t){"use strict";var r=function(){var n=function(e){return e instanceof n?e:this instanceof n?(t.isElement(e)&&(e=[e]),t.forEach(e,function(t,n){this[n]=t},this),this.length=e.length,void(this.$$events=[])):new n(e)},e=function(t,n,e,r){r.addEventListener(n,e),t.$$events.push({event:n,callback:e,node:r})},r=function(t,n,e,r){r.removeEventListener(n,e)},i=function(n,e){return t.forEach(n,e,n),n};return n.prototype={children:function(){var e=[];return i(this,function(n){t.forEach(n.childNodes,function(t){1===t.nodeType&&e.push(t)})}),new n(e)},eq:function(t){return new n(this[t])},on:function(t,n){return i(this,function(r){e(this,t,n,r)})},off:function(){for(var t=0,n=this.$$events.length;n>t;++t){var e=this.$$events[t];r(this,e.event,e.callback,e.node)}this.$$events=[]},empty:function(){return i(this,function(t){for(;t.firstChild;)t.removeChild(t.firstChild)})},remove:function(){return i(this,function(t){t.parentNode.removeChild(t)})},append:function(t){return i(this,function(n,e,r){var i=e===r.length-1?t:t.cloneNode(!0);n.appendChild(i)})},prepend:function(t){return i(this,function(n,e,r){var i=e===r.length-1?t:t.cloneNode(!0);n.insertBefore(i,n.childNodes[0])})},after:function(t){return i(this,function(n,e,r){var i=e===r.length-1?t:t.cloneNode(!0);n.parentNode.insertBefore(i,n.nextSibling)})},css:function(n,e){var r,s;return t.isObject(n)?(r=n,s=t.keys(r)):(r={},r[n]=e,s=[n]),i(this,function(n){t.forEach(s,function(t){n.style[t]=r[t]})})},addClass:function(t){return i(this,function(n){var e=n.className;n.className=(e?e+" ":"")+t})},removeClass:function(n){var e=n.split(" "),r=t.indexBy(e,function(t){return t});return i(this,function(n){var e=n.className,i=t.filter(e.split(" "),function(t){return!r[t]});n.className=i.join(" ")})},html:function(t){return i(this,function(n){n.innerHTML=t})},attr:function(n,e){var r,s=n;return 2===arguments.length?(s={},s[n]=e,r=[n]):r=t.keys(s),i(this,function(n){t.forEach(r,function(t){n.setAttribute(t,s[t])})})},removeAttr:function(t){return i(this,function(n){n.removeAttribute(t)})}},n}(),i=function(n){var r=i.$split(n),s=r.length;return function(n){for(var i=n,o=0;s>o;++o){if(null==i||!t.isObject(i))return e;i=t.result(i,r[o])}return i}};i.$normalize=function(t){for(var n=[],e=t.split("."),r=/(.+?)?(\[(\d+)\])/,i=/(.+?)?(\['(.+)'\])/,s=/(.+?)?(\["(.+)"\])/,o=function(t,n,e,r){var i=n?n+".":"";return i+r},a=0,u=e.length;u>a;++a){var h=e[a].replace(r,o).replace(i,o).replace(s,o),c=h.indexOf("(");c>0&&(h=h.slice(0,c)),n[a]=h}return n.join(".")},i.$split=function(t){return i.$normalize(t).split(".")};var s=function(t){var e=n.createElement("div");return e.appendChild(n.createTextNode(t)),e.innerHTML},o="waffle-",a=o+"sortable",u=a+"-asc",h=a+"-desc",c=o+"fixedheader",l="data-waffle-",f=l+"id",d=l+"sortable",$=l+"order",p="+",v="-",y=function(){var n="key_",e=function(t){return n+t},r=function(){return this instanceof r?void(this.$o={}):new r};return r.prototype={clear:function(){this.$o={}},put:function(t,n){return this.$o[e(t)]=n,this},get:function(t){return this.$o[e(t)]},remove:function(t){return delete this.$o[e(t)],this},contains:function(n){return t.has(this.$o,e(n))}},r}(),m=function(){var e=function(){var t=n.createElement("div");t.style.width="100px",t.style.height="100px",t.style.overflow="scroll",t.style.position="absolute",t.style.top="-9999px",n.body.appendChild(t);var e=t.offsetWidth-t.clientWidth;return n.body.removeChild(t),e},r=function(){return"body"},i={create:function(t){return n.createElement(t)},byId:function(t){var e=n.getElementById(t);return e?[e]:[]},byTagName:function(t,e){return(e||n).getElementsByTagName(t)},createFragment:function(){return n.createDocumentFragment()},scrollbarWidth:t.memoize(e,r)};return t.forEach(["tr","td","th","tbody","thead"],function(t){i[t]=function(){return this.create(t)}}),i}(),g={toPx:function(n){return t.isNumber(n)?n+"px":n},fromPx:function(n){return t.isString(n)?Number(n.replace("px","")):n}},b=function(){var n=Array.prototype,r=function(){try{var t={};return t[0]=1,!!n.toString.call(t)}catch(e){return!1}}(),s=function(e){return function(){var i=r?this:t.toArray(this);return n[e].apply(i,arguments)}},o=function(t,n,e){return s(t).apply(n,e)},a=function(n,e){this.$$map=new y;var r=e||{};this.$$key=r.key||"id",this.$$model=r.model||Object,t.isFunction(this.$$key)||(this.$$key=i(this.$$key)),this.$$observers=[],this.$$changes=[],this.length=0,n&&n.length&&this.push.apply(this,n)},u=function(t){return parseInt(Number(t)||0,10)},h="splice",c="update",l=function(t,n,e,r,i){return{type:t,removed:n,index:e,addedCount:r,object:i}},f=function(t,n){delete t[n]},d=function(t,n){t.$$map.remove(n)},$=function(t,n){var e=t.$$key(n),r=t.$$map.get(e);null!=r&&(f(t,r),d(t,e))},p=function(n,e){if(!t.isObject(e))throw new Error("Waffle collections are not array, only object are allowed");return e instanceof n.$$model?e:new n.$$model(e)},v=function(t,n,e){t[e]=n,null!=n&&t.$$map.put(t.$$key(n),e)},m=function(t,n,e){var r=t.at(e),i=t.at(n);v(t,i,e),v(t,r,n)},g=function(t,n,e){for(var r=Math.abs(e),i=t.length-1;i>=n;--i)m(t,i,i+r);t.length+=r},b=function(t,n,e){for(var r=Math.abs(e),i=t.length,s=i-r,o=n+r,a=[],u=o;i>u;++u)m(t,u,u-r);for(var h=s;i>h;++h){var c=t.at(h);a.unshift(c),$(t,c)}return t.length=s,a},w=function(n,e){for(var r,i=n.$$sortFn,s=n.length,o=e.length,a=s+o,u=[],c=s-1,f=o-1,d=a-1;d>=0;--d)if(0>c||i(n[c],e[f])<0){if(v(n,e[f--],d),r=t.first(u),r&&r.index===d+1?(r.index=d,r.addedCount++):(r=l(h,[],d,1,n),u.unshift(r)),0>f)break}else v(n,n[c--],d);return n.length=a,u},x=function(t){t.callback.call(t.ctx,this.$$changes)};return a.prototype={at:function(t){return this[t]},byKey:function(t){var n=this.indexByKey(t);return n>=0?this.at(n):e},indexByKey:function(t){return this.$$map.contains(t)?this.$$map.get(t):-1},findIndex:function(t,n){for(var e=0,r=this.length;r>e;++e)if(t.call(n,this.at(e),e,this))return e;return-1},add:function(t,n){var e=[t,0].concat(n);return this.splice.apply(this,e),this.length},remove:function(t,n){return this.splice.call(this,t,n)},push:function(){return this.add.call(this,this.length,t.toArray(arguments))},unshift:function(){return this.add.call(this,0,t.toArray(arguments))},pop:function(){return this.remove(this.length-1,1)[0]},shift:function(){return this.remove(0,1)[0]},clear:function(){if(this.length>0){for(var t=[],n=0,e=this.length;e>n;++n)t[n]=this.at(n),f(this,n);this.$$map.clear(),this.length=0,this.trigger(l(h,t,0,0,this))}return this},reset:function(t){var n=this.length,e=t.length,r=this.$$sortFn;r&&t.sort(r),this.$$map.clear();for(var i=[],s=t.length,o=0;e>o;++o)n>o&&i.push(this.at(o)),v(this,p(this,t[o]),o);for(;n>o;++o)i.push(this.at(o)),f(this,o);return this.length=e,this.trigger([l(h,i,0,s,this)]),this},isEmpty:function(){return 0===this.length},concat:function(){var t=n.concat.apply(this.toArray(),arguments);return new a(t,{key:this.$$key,model:this.$$model})},slice:function(){var t=o("slice",this,arguments);return new a(t,{key:this.$$key,model:this.$$model})},splice:function(n,e){var r=this.$$sortFn,i=this.length,s=t.rest(arguments,2),o=function(t){return p(this,t)},a=t.map(s,o,this),c=a.length,f=u(n);f=f>=0?Math.min(i,f):Math.max(i+f,0);var d=Math.min(Math.max(u(e)||0,0),i-f),$=[];if(d>0){for(var y=0;d>y;++y)$.push(this[y+f]);b(this,f,d)}var m;if(c>0)if(r)a.sort(r),m=w(this,a);else{g(this,f,c);for(var x=0;c>x;++x)v(this,a[x],f+x);m=[l(h,$,f,c,this)]}else m=[];if($.length>0){var C=t.find(m,function(t){return t.index===f});C?C.removed=$:m.unshift(l(h,$,f,0,this))}return m&&m.length>0&&this.trigger(m),$},reverse:function(){if(this.$$sortFn)return this;for(var t=this.length,n=Math.floor(t/2),e=[],r=[],i=0,s=t-1;n>i;++i,--s)m(this,i,s),e.push(l(c,[],i,0,this)),r.unshift(l(c,[],s,0,this));var o=e.concat(r);return o.length&&this.trigger(o),this},split:function(t){for(var n=t||20,e=[],r=[],i=0,s=this.length;s>i;++i)r.push(this.at(i)),r.length===n&&(e.push(r),r=[]);return r.length>0&&e.push(r),e},toJSON:function(){return JSON.stringify(this.toArray())},sort:function(t){return this.$$sortFn=t,this.reset(this.toArray()).clearChanges()},pluck:function(t){return this.map(i(t))},observe:function(t,n){return this.$$observers.push({ctx:n||null,callback:t}),this},unobserve:function(n,e){if(0===arguments.length)this.$$observers=[];else{var r=e||null;this.$$observers=t.reject(this.$$observers,function(t){return t.ctx===r&&n===t.callback})}return this},trigger:function(n){this.$$changes=this.$$changes.concat(n);var e=this;return setTimeout(function(){e.$$changes.length>0&&(t.forEach(e.$$observers,x,e),e.$$changes=[]),e=null}),this},clearChanges:function(){return this.$$changes=[],this}},t.forEach(["indexOf","size","lastIndexOf","first","last","initial","rest","partition","forEach","map","every","some","reduce","reduceRight","filter","reject","find","toArray"],function(n){t[n]&&(a.prototype[n]=function(){var e=[this].concat(t.toArray(arguments));return t[n].apply(t,e)})}),t.forEach(["countBy","groupBy","indexBy"],function(n){a.prototype[n]=function(e,r){return t.isString(e)&&(e=i(e)),t[n].call(t,this,e,r)}}),t.forEach(["toString","toLocaleString","join"],function(t){a.prototype[t]=s(t)}),a}(),w=function(){var n=function(t){return(null==t?"":t).toString()},e={$identity:t.identity,$empty:function(){return""},$lowercase:function(t){return n(t).toLowerCase()},$uppercase:function(t){return n(t).toUpperCase()},$capitalize:function(t){var e=n(t);return e.charAt(0).toUpperCase()+e.slice(1)},$get:function(t){return e[t]}};return e}(),x={$string:function(t,n){var e=null==t?"":String(t),r=null==n?"":String(n);return e.localeCompare(r)},$number:function(t,n){var e=null==t?0:Number(t),r=null==n?0:Number(n);return e-r},$boolean:function(t,n){var e="false"===t?0:Boolean(t)?1:0,r="false"===n?0:Boolean(n)?1:0;return e-r},$date:function(t,n){var e=new Date(null==t?0:t).getTime(),r=new Date(null==n?0:n).getTime();return e-r},$auto:function(n,e){if(n===e||null==n&&null==e)return 0;var r=t.find(["Number","Boolean","Date","String"],function(r){var i=t["is"+r];return i(n)||i(e)});return r?x["$"+r.toLowerCase()](n,e):e>n?-1:1},$get:function(t){return x[t]}},C=function(n){return t.isArray(n)||(n=[n]),function(t,e){if(t===e||null==t&&null==e)return 0;for(var r=0,i=n.length;i>r;++r){var s=n[r],o=s.parser(t),a=s.parser(e),u=s.fn.call(x,o,a);if(u)return s.desc?-1*u:u}return 0}},B=function(){var n=t.isUndefined,e="$identity",r="$auto",o=g.fromPx,c=g.toPx,l=function(n,e,r){return t.isString(n)&&(n=e.$get(n)),t.isFunction(n)||(n=e.$get(r)),n},y=function(a){var u=a.escape,h=a.sortable;this.id=a.id,this.title=a.title||"",this.field=a.field||this.id,this.css=a.css||this.id,this.escape=n(u)?!0:!!u,this.width=o(a.width),this.sortable=n(h)?!0:!!h,this.asc=n(a.asc)?null:!!a.asc,u&&(this.title=s(this.title));var c=a.renderer||e,f=t.isArray(c)?c:[c];this.$renderer=t.map(f,function(t){return l(t,w,e)}),this.$comparator=l(a.comparator,x,r),this.$parser=i(this.field)};return y.prototype={cssClasses:function(){var t=[this.css];this.sortable&&t.push(a);var n=this.asc;return null!=n&&t.push(n?u:h),t.join(" ")},attributes:function(t,n){var e={};if(e[f]=this.id,n&&this.sortable){e[d]=!0;var r=this.asc;null!=r&&(e[$]=r?p:v)}return e},styles:function(){var t={},n=c(this.width);return n&&(t.width=n,t.maxWidth=n,t.minWidth=n),t},updateWidth:function(t){return this.width=o(t),this},render:function(n){var e=this.field,r=null==n?"":this.$parser(n),i=t.reduce(this.$renderer,function(t,r){return r.call(w,t,n,e)},r);return null==i?"":this.escape?s(i):i}},y}(),N=function(){var n=g.toPx,e=g.fromPx,s=function(n){var e=n||[];return t.isArray(e)||(e=[e]),t.map(e,function(t){var n=t.charAt(0);return n!==p&&n!==v?p+t:t})},o=function(n,e,r){var i=n.options.events[e];return i!==t.noop&&i.apply(n,(r||t.noop).call(n)),n},a=function(t){var n=t.$table[0];if(t.$tbody=r(m.byTagName("tbody",n)),t.$thead=r(m.byTagName("thead",n)),!t.$thead.length){var e=m.thead();t.$thead=r(e),t.$table.append(e)}if(!t.$tbody.length){var i=m.tbody();t.$tbody=r(i),t.$table.append(i)}return t},l=function(t,n){var e=m.tr();return t.$columns.forEach(function(t,i){var s=r(m.td()).addClass(t.cssClasses(i,!1)).css(t.styles(i,!1)).attr(t.attributes(i,!1)).html(t.render(n));e.appendChild(s[0])}),e},y=function(n,i){if(!(this instanceof y))return new y(n,i);t.defaults(i.events||{},y.options.events),this.options=t.defaults(i||{},y.options),this.$table=r(n),this.$data=new b(i.data||[],{key:i.key}),this.$columns=new b(i.columns||[],{key:"id",model:B});var s=i.size;this.options.size={width:e(s.width),height:e(s.height)},this.$sortBy=[],a(this),this.$$bind().$$observe().assignWidth().renderHeader().sortBy(i.sortBy,!1).renderBody(),o(this,"onInitialized")};return y.create=function(t,n){return new y(t,n)},y.prototype={data:function(){return this.$data},columns:function(){return this.$columns},render:function(){return this.renderHeader().renderBody()},assignWidth:function(){var t=this.options.size,e=t.width;if(t.height){var r=n(t.width);this.$table.addClass(c).css({width:r,maxWidth:r,minWidth:r}),this.$tbody.css({maxHeight:n(t.height)}),e-=m.scrollbarWidth()}var i=0,s=0;this.$columns.forEach(function(t){var n=t.width;n&&(i+=n,++s)});var o=this.$columns.length,a=o-s,u=0,h=0;if(a){var l=(e-i)/a;u=Math.floor(l),h=l-u}var f=0;return this.$columns.forEach(function(t){var n=t.width,e=n||0;e||(f+=h,f>=1?(e=u+1,f--):e=u),e!==n&&t.updateWidth(e)}),this},renderHeader:function(){var t=m.tr();return this.$columns.forEach(function(n,e,i){var s=r(m.th()).addClass(n.cssClasses(e,!0)).css(n.styles(e,!0)).attr(n.attributes(e,i,!0)).html(n.title);t.appendChild(s[0])}),this.$thead.empty().append(t),this},renderBody:function(n){var e=null==n?this.options.async:n,r=this,i=function(t,n){for(var e=m.createFragment(),r=0,i=n.length;i>r;++r){var s=l(t,n[r]);e.appendChild(s)}return e},s=function(n){n.$data.clearChanges(),o(n,"onRendered",function(){return[this.$data,t.toArray(this.$tbody[0].childNodes)]}),n=i=s=null};if(e){var a=10,u=this.$data.split(200),h=function(){if(u.length>0){var t=i(r,u.shift());r.$tbody.append(t),setTimeout(h,a)}else s(r),h=u=null};this.$tbody.empty(),setTimeout(h)}else{var c=i(r,r.data());r.$tbody.empty().append(c),s(r)}return this},sortBy:function(n,e){var r=s(n);if(this.$sortBy===r||this.$sortBy.join()===r.join())return this;this.$sortBy=r;var a=this.$thead.children().eq(0),c=a.children();c.removeClass(u+" "+h).removeAttr($);var l=this.$columns,f=t.map(this.$sortBy,function(t){var n,e=t.charAt(0),r=t.substr(1),s=e===p,o=l.indexByKey(r);return o>=0?(n=l.at(o),n.asc=s,c.eq(o).addClass(s?u:h).attr($,e)):n={},{parser:n.$parser||i(t),fn:n.$comparator||x.$auto,desc:!s}});return this.$data.sort(C(f)),e!==!1&&this.renderBody(),o(this,"onSorted")},destroy:function(){return this.$$unbind().$$unobserve().$$destroy()},$$destroy:function(){for(var t in this)this.hasOwnProperty(t)&&(this[t]=null);return this},$$bind:function(){var t=this;return this.$thead.on("click",function(n){var e=n.target;if(e.getAttribute(d)){var r,i=e.getAttribute(f),s=e.getAttribute($)||v,o=s===p?v:p,a=o+i;if(n.shiftKey){r=t.$sortBy.slice();var u=s+i,h=r.indexOf(u);h>=0&&r.splice(h,1),r.push(a)}else r=[a];t.sortBy(r)}}),this},$$unbind:function(){return this.$thead.off(),this},$$observe:function(){return this.$data.observe(this.$$onDataChange,this),this},$$unobserve:function(){return this.$data.unobserve(),this},$$onDataChange:function(n){return t.forEach(n,function(t){var n=t.type,e="$$on_"+n;this[e](t)},this),this},$$on_splice:function(n){var e=n.index,r=n.addedCount,i=n.object,s=n.removed.length;if(s>0){var a;if(0===e&&s===this.$tbody[0].childNodes.length)a=t.toArray(this.$tbody[0].childNodes),this.$tbody.empty();else{a=[];for(var u=0;s>u;++u){var h=u+e,c=this.$tbody.children().eq(h);a.push(c[0]),c.remove()}}o(this,"onRemoved",function(){return[n.removed,a,e]})}if(r>0){for(var f=m.createFragment(),d=[],$=[],p=0;r>p;++p){var v=p+e,y=i.at(v),g=l(this,y);$.push(g),d.push(y),f.appendChild(g)}e>0?this.$tbody.children().eq(e-1).after(f):this.$tbody.prepend(f),o(this,"onAdded",function(){return[d,$,e]})}return this},$$on_update:function(t){var n=t.index,e=this.$data.at(n),r=this.$tbody[0],i=r.childNodes[n],s=l(this,e);return r.replaceChild(s,i),this}},y.options={key:"id",async:!1,size:{width:null,height:null},events:{}},t.forEach(["onInitialized","onRendered","onAdded","onRemoved","onSorted"],function(n){y.options.events[n]=t.noop}),y}(),E={Grid:N,addRenderer:function(t,n){return w[t]=n,E},addComparator:function(t,n){return x[t]=n,E}};return E})}(window,document,void 0);