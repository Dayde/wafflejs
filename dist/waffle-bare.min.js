!function(t,e,n){!function(e){"function"==typeof define&&define.amd?define(["jquery","underscore"],e):"object"==typeof exports?module.exports=e(require("jquery"),require("underscore")):t.Waffle=e(jQuery,_)}(function(i,r){"use strict";var s={toJson:function(t){if(!JSON||!JSON.stringify)throw new Error("JSON.stringify is not available in your browser");return JSON.stringify(t)},fromJson:function(t){if(!JSON||!JSON.parse)throw new Error("JSON.parse is not available in your browser");return JSON.parse(t)}},o=function(){var t="key_",e=function(e){return t+e},n=function(){return this instanceof n?void(this.$o={}):new n};return n.prototype={clear:function(){this.$o={}},put:function(t,n){return this.$o[e(t)]=n,this},get:function(t){return this.$o[e(t)]},remove:function(t){return delete this.$o[e(t)],this},contains:function(t){return r.has(this.$o,e(t))}},n}(),a=function(){var t=e.documentMode,n=new o,i={input:"input"},r={hasEvent:function(r){if("input"===r&&11>t)return!1;if(!n.contains(r)){var s=e.createElement(i[r]||"div"),o="on"+r in s;n.put(r,!!o),s=null}return n.get(r)}};return r}(),h=function(){var t=new o,e=function(t){for(var e=[],n=t.split("."),i=/(.+?)?(\[(\d+)\])/,r=/(.+?)?(\['(.+)'\])/,s=/(.+?)?(\["(.+)"\])/,o=function(t,e,n,i){var r=e?e+".":"";return r+i},a=0,h=n.length;h>a;++a){var u=n[a].replace(i,o).replace(r,o).replace(s,o),l=u.indexOf("(");l>0&&(u=u.slice(0,l)),e[a]=u}return e.join(".")},i=function(t){return e(t).split(".")},s=function(t){if(null==t)return{};if(!r.isObject(t))throw new Error('Cannot assign to ready property "'+t+'"');return t},a=function(t,e){for(var i=t.length,s=e,o=0;i>o;++o){if(null==s||!r.isObject(s))return n;s=r.result(s,t[o])}return s},h=function(t,e,n){for(var i=t.length-1,o=e,a=o,h=0;i>h;++h)a=r.result(o,t[h]),a=o[t[h]]=s(a);return a[r.last(t)]=n,n},u=function(e){if(!t.contains(e)){var n=i(e),r=function(t){return a(n,t)};r.assign=function(t,e){return h(n,t,e)},t.put(e,r)}return t.get(e)};return u.$clear=function(){return t.clear(),u},u.assign=function(){},u}(),u=function(t){return r.escape(t)},l="waffle-",c="waffle-grid",d=l+"sortable",f=d+"-asc",p=d+"-desc",v=l+"draggable",g=v+"-drag",b=v+"-over",$=l+"fixedheader",m=l+"selectable",y=l+"selected",C=l+"checkbox",x="data-waffle-",w=x+"id",E=x+"sortable",N=x+"order",k=x+"idx",S="+",A="-",D="tbody",T="thead",z="tfoot",O="table",B={msie:function(){return e.documentMode},endWith:function(t,e){return!!t&&t.slice(t.length-e.length)===e},isPx:function(t){return B.endWith(t,"px")},isPercentage:function(t){return B.endWith(t,"%")},fromPercentage:function(t){return r.isString(t)?Number(t.replace("%","")):t},toPx:function(t){return r.isNumber(t)?t+"px":t},fromPx:function(t){return r.isString(t)?Number(t.replace("px","")):t},capitalize:function(t){return t.charAt(0).toUpperCase()+t.slice(1)},resultWith:function(t,e,n){return r.isFunction(t)?t.apply(e,n):t},parse:function(t){try{return s.fromJson(t)}catch(e){if("false"===t)return!1;if("true"===t)return!0;var n=Number(t);return r.isNaN(n)?t:n}},destroy:function(t){for(var e in t)r.has(t,e)&&(t[e]=null)},toSpinalCase:function(t){for(var e="",n=0,i=t.length;i>n;++n){var r=t.charAt(n);e+=r.toLowerCase()===r?r:"-"+r.toLowerCase()}return e},asyncTask:function(t,e,n,i){var r=0,s=function(){if(t.length>0){var o=t.shift();n(o,r),r+=o.length,t.length>0?setTimeout(s,e):(i(),s=null)}};setTimeout(s)}},j=function(){var t=function(){var t=e.createElement("div");t.style.width="100px",t.style.height="100px",t.style.overflow="scroll",t.style.position="absolute",t.style.top="-9999px",e.body.appendChild(t);var n=t.offsetWidth-t.clientWidth;return e.body.removeChild(t),n},n=function(){return"body"},i={create:function(t){return e.createElement(t)},byId:function(t){var n=e.getElementById(t);return n?[n]:[]},byTagName:function(t,n){return(n||e).getElementsByTagName(t)},createFragment:function(){return e.createDocumentFragment()},findParent:function(t,e){for(;t&&t.tagName!==e;)t=t.parentNode;return t},scrollbarWidth:r.memoize(t,n)};return r.forEach(["tr","td","th",D,T,z,"input","select","option","span"],function(t){i[t]=function(){return this.create(t)}}),r.forEach(["text","checkbox","number","email","url","date","time","datetime"],function(t){var e="input"+B.capitalize(t);i[e]=function(){var e=this.input();return e.setAttribute("type",t),e}}),i}(),W=function(){var t=function(t,e,n){return t.replaceChild(n,e)},e=function(t,e){t.nodeValue!==e.nodeValue&&(t.nodeValue=e.nodeValue)},n=function(t,e){for(;t.firstChild;)t.removeChild(t.firstChild);for(;e.firstChild;)t.appendChild(e.firstChild)},i=function(t,e){s.mergeAttributes(t,e);var i=t.childNodes,r=e.childNodes;if(i.length!==r.length)n(t,e);else for(var o=0,a=i.length;a>o;++o)s.mergeNodes(t,i[o],r[o])},s={mergeNodes:function(n,r,s){var o=r.nodeType,a=s.nodeType,h=r.tagName,u=s.tagName,l=r;return o!==a||h!==u?(t(n,r,s),l=s):3===o?e(r,s):i(r,s),l},mergeAttributes:function(t,e){var n=r.indexBy(t.attributes,"name"),i=r.indexBy(e.attributes,"name");r.forEach(r.keys(i),function(e){var r=n[e]||null,s=r?r.value:null,o=i[e].value;s!==o&&t.setAttribute(e,o),r&&delete n[e]}),r.forEach(r.keys(n),function(e){t.removeAttribute(e)})}};return s}(),F=function(){var t=r.noop,e=function(t,e,n){this.type=t,this.bubbles=!1,this.cancelable=!1,this.details=n,this.timeStamp=r.now(),this.target=e,this.currentTarget=e,this.srcElement=e};e.prototype={preventDefault:t,stopPropagation:t,stopImmediatePropagation:t};var n=function(t){return t.toLowerCase()},i=function(){this.$events={}};return i.prototype={addEventListener:function(t,e){var i=n(t),r=this.$events,s=r[i]=r[i]||[];s.push(e)},removeEventListener:function(t,e){var i=n(t),s=this.$events[i];s&&s.length&&(this.$events[i]=r.reject(s,function(t){return t===e}))},dispatchEvent:function(t,i,s){i=n(i);var o=this.$events[i];if(o&&o.length)for(var a=new e(i,t,r.isFunction(s)?s.call(t):s),h=0,u=o.length;u>h;++h)try{o[h].call(t,a)}catch(l){}},clear:function(){this.$events={}}},i}(),P=function(){var t=function(t){return t&&t.length>0},e=function(){var e=this.$$changes,n=this.$$observers;if(t(e)&&t(n)){var i=e.splice(0,e.length);r.forEach(n,function(t){t.callback.call(t.ctx,i)})}},n={observe:function(t,e){return this.$$observers=this.$$observers||[],this.$$observers.push({ctx:e||null,callback:t}),this},unobserve:function(e,n){if(t(this.$$observers))if(0===arguments.length)this.$$observers=[];else{var i=n||null;this.$$observers=r.reject(this.$$observers,function(t){return t.ctx===i&&e===t.callback})}return this},trigger:function(t){return r.isArray(t)||(t=[t]),this.$$changes=this.$$changes||[],this.$$changes.push.apply(this.$$changes,t),setTimeout(r.bind(e,this)),this},pendingChanges:function(){return this.$$changes||[]},clearChanges:function(){return this.$$changes&&this.$$changes.splice(0,this.$$changes.length),this}};return n}(),R=function(){var t=Array.prototype,e=function(){try{var e={};return e[0]=1,!!t.toString.call(e)}catch(n){return!1}}(),i=function(n){return function(){var i=e?this:r.toArray(this);return t[n].apply(i,arguments)}},s=function(t,e,n){return i(t).apply(e,n)},a=function(t,e){var n=e||{};this.$$map=new o,this.$$model=n.model||Object,this.$$key=n.key||"id",r.isFunction(this.$$key)||(this.$$key=h(this.$$key)),this.length=0,t&&t.length&&this.push.apply(this,t)},u=function(t){return parseInt(Number(t)||0,10)},l="splice",c="update",d=function(t,e,n,i,r){return{type:t,removed:e,index:n,addedCount:i,object:r}},f=function(t,e){delete t[e]},p=function(t,e){t.$$map.remove(e)},v=function(t,e){var n=t.$$key(e),i=t.$$map.get(n),r=i?i.idx:null;null!=r&&(f(t,r),p(t,n))},g=function(t,e){if(!r.isObject(e))throw new Error("Waffle collections are not array, only object are allowed");var n;n=e instanceof t.$$model?e:new t.$$model(e);var i=t.$$key(n);if(null==i)throw new Error("Collection elements must have an id, you probably missed to specify the id key on initialization ?");return n},b=function(t,e,n,i){if(t[n]=e,null!=e){var r=arguments.length,s=3===r?t.$$key(e):i,o=t.$$map.get(s)||{};o.idx=n,t.$$map.put(s,o)}},$=function(t,e){var n=t.indexOf(e);return t[n]=e,d(c,[],n,0,t)},m=function(t,e,n){var i=t.at(n),r=t.at(e);b(t,r,n),b(t,i,e)},y=function(t,e,n){for(var i=Math.abs(n),r=t.length-1;r>=e;--r)m(t,r,r+i);t.length+=i},C=function(t,e,n){for(var i=Math.abs(n),r=t.length,s=r-i,o=e+i,a=[],h=o;r>h;++h)m(t,h,h-i);for(var u=s;r>u;++u){var l=t.at(u);a.unshift(l),v(t,l)}return t.length=s,a},x=function(t,e){for(var n,i=t.$$sortFn,s=t.length,o=e.length,a=s+o,h=[],u=s-1,c=o-1,f=a-1;f>=0;--f)if(0>u||i(t[u],e[c])<0){if(b(t,e[c--],f),n=r.first(h),n&&n.index===f+1?(n.index=f,n.addedCount++):(n=d(l,[],f,1,t),h.unshift(n)),0>c)break}else b(t,t[u--],f);return t.length=a,h};return a.prototype={options:function(){return{model:this.$$model,key:this.$$key}},at:function(t){return this[t]},byKey:function(t){var e=this.indexOf(t);return e>=0?this.at(e):n},indexOf:function(t){var e=r.isObject(t)?this.$$key(t):t;return this.$$map.contains(e)?this.$$map.get(e).idx:-1},contains:function(t){return this.indexOf(t)>=0},findIndex:function(t,e){for(var n=0,i=this.length;i>n;++n)if(t.call(e,this.at(n),n,this))return n;return-1},add:function(t,e){var n=null==e?this.length:e,i=[n,0].concat(t);return this.splice.apply(this,i),this.length},remove:function(t,e){if(r.isNumber(t))return this.splice.call(this,t,e||this.length);if(r.isArray(t)){var n=this.$$key,i=r.indexBy(t,n);return this.remove(function(t){return!!i[n(t)]})}for(var s=t,o=e,a=0,h=null,u=[],c=[],v=0,g=this.length;g>v;++v){var $=this.at(v),m=this.$$key($);s.call(o,$,v)?(f(this,v),p(this,m),h===v-1?r.last(u).removed.push($):u.push(d(l,[$],v,0,this)),c.push($),h=v):(a!==v&&(f(this,v),p(this,m),b(this,$,a,m)),a++)}return this.length-=c.length,u.length>0&&this.trigger(u),c},triggerUpdate:function(t){return this.trigger([d(c,[],t,0,this)]),this},replace:function(t){var e=[0,0].concat(t);return this.splice.apply(this,e),this},push:function(){return this.add.call(this,r.toArray(arguments))},unshift:function(){return this.add.call(this,r.toArray(arguments),0)},pop:function(){return this.remove(this.length-1,1)[0]},shift:function(){return this.remove(0,1)[0]},toggle:function(t){var e=this.indexOf(t);return e>=0?this.remove(e,1):this.push(t)},clear:function(){if(this.length>0){for(var t=[],e=0,n=this.length;n>e;++e)t[e]=this.at(e),f(this,e);this.$$map.clear(),this.length=0,this.trigger(d(l,t,0,0,this))}return this},reset:function(t){var e=this.length,n=t.length,i=this.$$sortFn;i&&t.sort(i),this.$$map.clear();for(var r=[],s=t.length,o=0;n>o;++o)e>o&&r.push(this.at(o)),b(this,g(this,t[o]),o);for(;e>o;++o)r.push(this.at(o)),f(this,o);return this.length=n,this.trigger([d(l,r,0,s,this)]),this},isEmpty:function(){return 0===this.length},concat:function(){var e=t.concat.apply(this.toArray(),arguments);return new a(e,this.options())},slice:function(){var t=s("slice",this,arguments);return new a(t,this.options())},splice:function(t,e){var n=this.$$sortFn,i=this.length,s=r.rest(arguments,2),o=function(t){return g(this,t)},a=r.map(s,o,this),h=u(t);h=h>=0?Math.min(i,h):Math.max(i+h,0);var c=Math.min(Math.max(u(e)||0,0),i-h),f=[];if(c>0){for(var p=0;c>p;++p)f.push(this[p+h]);C(this,h,c)}var v,m=r.groupBy(a,this.contains,this),w=m[!0]||[],E=m[!1]||[],N=E.length,k=w.length;if(N>0)if(n)E.sort(n),v=x(this,E);else{y(this,h,N);for(var S=0;N>S;++S)b(this,E[S],h+S);v=[d(l,f,h,N,this)]}else v=[];if(f.length>0){var A=r.find(v,function(t){return t.index===h});A?A.removed=f:v.unshift(d(l,f,h,0,this))}var D=[];if(k>0){n&&w.sort(n);for(var T=0;k>T;++T)D.push($(this,w[T]))}var z=v.concat(D);return z.length>0&&this.trigger(z),f},reverse:function(){if(this.$$sortFn)return this;for(var t=this.length,e=Math.floor(t/2),n=[],i=[],r=0,s=t-1;e>r;++r,--s)m(this,r,s),n.push(d(c,[],r,0,this)),i.unshift(d(c,[],s,0,this));var o=n.concat(i);return o.length&&this.trigger(o),this},split:function(t){for(var e=t||20,n=[],i=[],r=0,s=this.length;s>r;++r)i.push(this.at(r)),i.length===e&&(n.push(i),i=[]);return i.length>0&&n.push(i),n},toJSON:function(){return JSON.stringify(this.toArray())},sort:function(t){return this.$$sortFn=t,this.reset(this.toArray()).clearChanges()},pluck:function(t){var e=h(t);return this.map(function(t){return e(t)})}},a.prototype.lastIndexOf=a.prototype.indexOf,r.extend(a.prototype,P),r.forEach(["size","first","last","initial","rest","partition","forEach","map","every","some","reduce","reduceRight","filter","reject","find","toArray"],function(t){r[t]&&(a.prototype[t]=function(){var e=[this].concat(r.toArray(arguments));return r[t].apply(r,e)})}),r.forEach(["countBy","groupBy","indexBy"],function(t){a.prototype[t]=function(e,n){if(r.isString(e)){var i=h(e);e=function(t){return i(t)}}return r[t].call(r,this,e,n)}}),r.forEach(["toString","toLocaleString","join"],function(t){a.prototype[t]=i(t)}),a}(),L=function(){var t=function(t){return(null==t?"":t).toString()},e={$identity:r.identity,$empty:function(){return""},$lowercase:function(e){return t(e).toLowerCase()},$uppercase:function(e){return t(e).toUpperCase()},$capitalize:function(e){return B.capitalize(t(e))},$get:function(t){return e[t]}};return e}(),U={$string:function(t,e){var n=null==t?"":String(t),i=null==e?"":String(e);return n.localeCompare(i)},$number:function(t,e){var n=null==t?0:Number(t),i=null==e?0:Number(e);return n-i},$boolean:function(t,e){var n="false"===t?0:Boolean(t)?1:0,i="false"===e?0:Boolean(e)?1:0;return n-i},$date:function(t,e){var n=r.isDate(t)?t.getTime():new Date(null==t?0:t).getTime(),i=r.isDate(e)?e.getTime():new Date(null==e?0:e).getTime();return n-i},$auto:function(t,e){if(t===e||null==t&&null==e)return 0;var n=r.find(["Number","Boolean","Date","String"],function(n){var i=r["is"+n];return i(t)||i(e)});return n?U["$"+n.toLowerCase()](t,e):e>t?-1:1},$get:function(t){return U[t]}},H=function(t){return r.isArray(t)||(t=[t]),function(e,n){if(e===n||null==e&&null==n)return 0;for(var i=0,r=t.length;r>i;++i){var s=t[i],o=s.parser(e),a=s.parser(n),h=s.fn.call(U,o,a);if(h)return s.desc?-1*h:h}return 0}},M=function(){var t={enable:!0,type:"text",css:null},e={".":"-","(":"",")":"","[":"-","]":"-","'":"",'"':""},n=r.isUndefined,i="$identity",s="$auto",o=B.resultWith,a=B.fromPx,l=B.toPx,c=function(t,e,n){return r.isString(t)&&(t=e.$get(t)),r.isFunction(t)||(t=e.$get(n)),t},g=function(o){r.isString(o)&&(o={id:o});var a=o.escape,l=o.sortable;this.id=o.id,this.title=o.title||"",this.field=o.field||this.id,this.css=o.css||"",this.escape=n(a)?!0:!!a,this.width=o.width,this.sortable=n(l)?!0:!!l,this.draggable=!!o.draggable,this.asc=null;var d=o.editable===!0?{}:o.editable;if(d&&(d=r.defaults(d,t)),this.editable=d,!this.css)for(var f=0,p=this.id.length;p>f;++f){var v=this.id.charAt(f),g=e[v];this.css+=null!=g?g:v}a&&(this.title=u(this.title));var b=o.renderer||i,$=r.isArray(b)?b:[b];this.$renderer=r.map($,function(t){return c(t,L,i)}),this.$comparator=c(o.comparator,U,s),this.$parser=h(this.field)};return g.prototype={cssClasses:function(t,e,n){var i=n?[n]:[],s=o(this.css,this,i);r.isArray(s)&&(s=s.join(" "));var a=[s];this.sortable&&a.push(d),this.draggable&&a.push(v);var h=this.asc;return null!=h&&a.push(h?f:p),a.join(" ")},attributes:function(t,e){var n={};if(n[w]=this.id,e){if(this.sortable){n[E]=!0;var i=this.asc;null!=i&&(n[N]=i?S:A)}this.draggable&&(n.draggable=!0)}return n},styles:function(){var t={},e=l(this.computedWidth);return e&&(t.width=e,t.maxWidth=e,t.minWidth=e),t},updateWidth:function(t){return this.width=a(t),this},isEditable:function(t){return this.editable&&this.editable.enable?t?o(this.editable.enable,this,[t]):!0:!1},render:function(t){var e=this.field,n=this.value(t),i=r.reduce(this.$renderer,function(n,i){return i.call(L,n,t,e)},n);return null==i?"":this.escape?u(i):i},value:function(t,e){var n=this.$parser;return 2===arguments.length?(n.assign(t,e),this):null==t?"":n(t)}},g}(),J=function(){var t="THEAD",e="TFOOT",n="TBODY",s="TH",o="TR",a="INPUT",h=function(t){return t.tagName===a&&"checkbox"===t.getAttribute("type")},u=function(t){return!!t.getAttribute("draggable")},l=function(t,e){var n=j.findParent(t,e.tagName);return n===e},c={number:function(t){return Number(t)},checkbox:function(t){return!!t}},d={checkbox:"checked"},f=function(t,e){var n=t.target,i=j.findParent(t.target,s);if(n.tagName!==e)if(this.isSelectable()&&h(n))n.checked?this.select():this.deselect();else if(i&&i.getAttribute(E)){var o,a=i.getAttribute(w),u=i.getAttribute(N)||A,l=u===S?A:S,c=l+a;if(t.shiftKey){var d=u+a;o=r.reject(this.$sortBy,function(t){return t===d})}else o=[];o.push(c),this.sortBy(o)}},p={onClickThead:function(e){return f.call(this,e,t)},onClickTfoot:function(t){return f.call(this,t,e)},onClickTbody:function(t){if(this.isSelectable()&&t.target.tagName!==n){var e=j.findParent(t.target,o),i=e.getAttribute(k),r=this.$data.at(i);if(this.isSelectable(r)){var s=this.$selection;if(this.options.selection.multi)if(t.shiftKey){for(var a=parseFloat(i),h=parseFloat(this.$$selectAnchor),u=Math.min(a,h),l=Math.max(a,h),c=[],d=u;l>=d;++d){var f=this.$data.at(d);!s.contains(f)&&this.isSelectable(f)&&c.push(f)}c.length>0&&s.push.apply(s,c)}else s.toggle(r),this.$$selectAnchor=i;else{var p=s.indexOf(r);p>=0?s.remove(p,1):s.reset([r])}}}},onInputTbody:function(t){var e=t.target,n=e.getAttribute(w),i=n?this.$columns.byKey(n):null;if(i&&i.isEditable()){var s=j.findParent(e,"TR");if(s){var o=i.editable.type,a=c[o]||r.identity,h=d[o]||"value",u=Number(s.getAttribute(k)),l=this.$data,f=l.at(u),p=i.value(f),v=a(e[h]);p!==v&&(i.value(f,v),this.dispatchEvent("datachanged",{index:u,object:f,field:n,oldValue:p,newValue:v}),l.triggerUpdate(u))}}},onDragStart:function(t){var e=t.target,n=t.originalEvent||t,r=n.dataTransfer;u(e)&&(i(e).addClass(g),r.effectAllowed="move",r.clearData(),r.setData("Text",e.getAttribute(w)))},onDragEnd:function(t){var e=t.target,n=this.$table[0];i(j.byTagName("th",n)).removeClass(b),u(e)&&l(e,n)&&i(t.target).removeClass(g)},onDragOver:function(t){var e=t.target;if(u(e)&&l(e,this.$table[0])){var n=t.originalEvent||t,i=n.dataTransfer;return i.dropEffect="move",t.preventDefault(),!1}},onDragEnter:function(t){var e=t.target;return u(e)&&l(e,this.$table[0])?(i(e).addClass(b),t.preventDefault(),!1):void 0},onDragLeave:function(t){var e=t.target;return u(e)&&l(e,this.$table[0])?(i(e).removeClass(b),t.preventDefault(),!1):void 0},onDragDrop:function(t){var e=t.target;if(u(e)&&l(e,this.$table[0])){var n=t.originalEvent||t,r=n.dataTransfer,s=r.getData("Text"),o=e.getAttribute(w);if(s!==o){var a=this.$columns,h=a.indexOf(s),c=a.indexOf(o);a.add(a.remove(h,1),c),i(e).removeClass(b)}return t.preventDefault(),!1}},onSelectStart:function(t){var e=t.target;return u(e)?(t.preventDefault(),e.dragDrop(),!1):void 0}};return p}(),I=function(){var e=function(t,e,n,i){var s=t["$"+e];s&&!t.$$events[i]&&(t.$$events[i]=r.bind(J[i],t),s.on(n,t.$$events[i]))},n=function(t,e,n,i){var r=t["$"+e];r&&t.$$events[i]&&(r.off(n,t.$$events[i]),t.$$events[i]=null)},s=function(){var t=a.hasEvent("input")?"input":"keyup";return t+=" change"},o="click",h={bindResize:function(e){if(!e.$$events.onResize){var n=r.bind(e.resize,e);e.$$events.onResize=r.debounce(n,100),i(t).on("resize",e.$$events.onResize)}},bindEdition:function(t){e(t,D,s(),"onInputTbody")},unbindEdition:function(t){n(t,D,s(),"onInputTbody")},bindSelection:function(t){e(t,T,o,"onClickThead"),e(t,z,o,"onClickTfoot"),e(t,D,o,"onClickTbody")},bindSort:function(t){e(t,T,o,"onClickThead"),e(t,z,o,"onClickTfoot")},bindDragDrop:function(t){e(t,O,"dragstart","onDragStart"),e(t,O,"dragover","onDragOver"),e(t,O,"dragend","onDragEnd"),e(t,O,"dragleave","onDragLeave"),e(t,O,"dragenter","onDragEnter"),e(t,O,"drop","onDragDrop"),B.msie()<=9&&e(t,O,"selectstart","onSelectStart")}};return h}(),q=function(){var t="px",e="percent",n="auto",s={};s[t]=function(t){return B.fromPx(t.computedWidth)},s[e]=function(t,e){return B.fromPercentage(t.computedWidth)*e/100},s[n]=function(t,e,n){return e/n};var o={checkbox:function(t){return!!t}},a={computeWidth:function(i,o){var a=i,h=0,u=o.groupBy(function(i){var s=i.computedWidth=r.result(i,"width");return r.isNumber(s)||B.isPx(s)?t:B.isPercentage(s)?e:n});r.forEach([t,e,n],function(t){var e=u[t];if(e){var n=a,i=e.length;r.forEach(e,function(e){var r=s[t](e,n,i);e.computedWidth=r,a-=r,h++})}})},theadRow:function(t){var e=j.tr();return t.hasCheckbox()&&e.appendChild(a.theadCheckboxCell(t)),t.$columns.forEach(function(n,i){e.appendChild(a.theadCell(t,n,i))}),e},theadCell:function(t,e,n){return i(j.th()).addClass(e.cssClasses(n,!0)).css(e.styles(n,!0)).attr(e.attributes(n,!0)).html(e.title)[0]},theadCheckboxCell:function(t){var e=t.$selection.size(),n=i(j.span()).attr("title",e).html(e),r=t.isSelected(),s=i(j.inputCheckbox()).prop("checked",r).prop("indeterminate",!r&&e>0);return i(j.th()).addClass(C).append(n[0]).append(s[0])[0]},tfootRow:function(t){var e=j.tr();return t.hasCheckbox()&&e.appendChild(a.tfootCheckboxCell(t)),t.$columns.forEach(function(n,i){e.appendChild(a.tfootCell(t,n,i))}),e},tfootCell:function(t,e,n){return a.theadCell(t,e,n)},tfootCheckboxCell:function(t){var e=a.theadCheckboxCell(t);return e.appendChild(e.childNodes[0]),e},tbodyRows:function(t,e,n){for(var i=j.createFragment(),r=0,s=e.length;s>r;++r)i.appendChild(a.tbodyRow(t,e[r],n+r));return i},tbodyRow:function(t,e,n){var r=i(j.tr());return r.attr(k,n),r.attr(w,t.$data.$$key(e)),t.isSelectable()&&(t.isSelectable(e)&&r.addClass(m),t.$selection.contains(e)&&r.addClass(y),t.hasCheckbox()&&r[0].appendChild(a.tbodyCheckboxCell(t,e))),t.$columns.forEach(function(n,i){r[0].appendChild(a.tbodyCell(t,e,n,i))}),r[0]},tbodyCell:function(t,e,n,r){var s=i(j.td()).addClass(n.cssClasses(r,!1,e)).css(n.styles(r,!1)).attr(n.attributes(r,!1)),o=n.isEditable(e);return o?s.append(a.tbodyControl(n,e)):s.html(n.render(e)),s[0]},tbodyCheckboxCell:function(t,e){var n=i(j.td()).addClass(C);if(t.isSelectable(e)){var r=i(j.inputCheckbox()).prop("checked",t.isSelected(e));n.append(r[0])}return n[0]},tbodyControl:function(t,e){var n,i=t.editable;"select"===i.type?(n=j.select(),i.options&&r.forEach(i.options,function(t){var e=j.option();e.innerHTML=null!=t.label?t.label:"",null!=t.value&&(e.value=t.value),n.appendChild(e)})):(n=j.input(),n.setAttribute("type",i.type)),n.setAttribute(w,t.id);var s="checkbox"===i.type?"checked":"value",a=o[i.type]||r.identity;return n[s]=a(t.value(e)),i.css&&(n.className=i.css),n}};return a}(),V=function(){var t="px",e="percent",n="auto",i={};i[t]=function(t){return B.fromPx(t)},i[e]=function(t,e){return B.fromPercentage(t)*e/100},i[n]=function(t,e,n){return e/n};var s={resize:function(t){s.applySize(t)},applySize:function(t){var e=t.options.size,i=r.result(e,"width"),o=r.result(e,"height"),a=i&&i!==n,h=o&&o!==n;if(a){var u=B.toPx(i);t.$table.css({width:u,maxWidth:u,minWidth:u})}if(h){var l=B.toPx(o);t.$tbody.css({maxHeight:l})}var c=a?B.fromPx(i):null;c||(c=t.$table[0].offsetWidth),c-=j.scrollbarWidth(),t.hasCheckbox()&&(c-=30);var d=t.$columns,f=s.computeWidth(c,d);if(f.length>0)for(var p=r.indexBy(d.pendingChanges(),function(t){return t.type+"_"+t.index}),v=0,g=f.length;g>v;++v){var b=d.indexOf(f[v]);r.has(p,"update_"+b)||d.triggerUpdate(b)}return this},computeWidth:function(s,a){var h=s,u=0,l=new o,c=a.groupBy(function(i){var s=r.result(i,"width");return l.put(i.id,s),r.isNumber(s)||B.isPx(s)?t:B.isPercentage(s)?e:n}),d=[];return r.forEach([t,e,n],function(t){var e=c[t];if(e){var n=h,s=e.length;r.forEach(e,function(e){var r=i[t](l.get(e.id),n,s);r!==e.computedWidth&&(e.computedWidth=r,d.push(e)),h-=r,u++})}}),d}};return s}(),K={on:function(t){return r.forEach(t,function(t){var e="on"+B.capitalize(t.type);K[e].call(this,t)},this),this},onSplice:function(t){var e,n,i,s=this.$tbody,o=s[0],a=o.childNodes,h=t.index,u=t.addedCount,l=t.object,c=t.removed,d=c.length;if(d>0){if(0===h&&d===a.length)e=r.toArray(a),s.empty();else{e=[];for(var f=0;d>f;++f)e.push(o.removeChild(a[h]))}var p=this.$selection;p&&p.length>0&&p.remove(c)}if(u>0){n=[],i=[];for(var v=j.createFragment(),g=0;u>g;++g){var b=g+h,$=l.at(b),m=q.tbodyRow(this,$,b);n.push(m),i.push($),v.appendChild(m)}h>0?s.children().eq(h-1).after(v):s.prepend(v)}if(e||n){for(var y=h+u,C=a.length;C>y;++y)a[y].setAttribute(k,y);this.dispatchEvent("dataspliced",{added:i||[],addedNodes:n||[],removedNodes:e||[],removed:c,index:h})}return this},onUpdate:function(t){var e=t.index,n=this.$data.at(e),i=this.$tbody[0],r=i.childNodes[e],s=q.tbodyRow(this,n,e),o=W.mergeNodes(i,r,s);return this.dispatchEvent("dataupdated",{index:e,oldNode:r,newNode:o}),this}},_=function(){var t=function(t){return t.getAttribute(w)},e=function(e,n){for(var i=[],s=e.childNodes,o=0,a=s.length;a>o;++o)for(var h=s[o],u=r.indexBy(h.childNodes,t),l=0,c=n.length;c>l;++l){var d=u[n[l].id];d&&i.push(h.removeChild(d))}return i},n=function(t,e,n){return t.insertBefore(e,t.childNodes[n]||null)},i={tbody:function(t,e,n){return q.tbodyCell(this,this.$data.at(n),t,e)},thead:function(t,e){return q.theadCell(this,t,e)},tfoot:function(t,e){return q.tfootCell(this,t,e)}},s=function(t,e,n){return function(r,s){var o=r.childNodes[n],a=i[t].call(this,e,n,s),h=W.mergeNodes(r,o,a);return{oldNode:o,newNode:h}}},o=function(t,e){e.draggable=!!e.draggable||!!t.isDraggable(),t.isSortable()||(e.sortable=!1)},a={on:function(t){return r.forEach(t,function(t){var e="on"+B.capitalize(t.type);a[e].call(this,t)},this),this},onSplice:function(i){var s,a,h,u,l,c=this.$tbody[0],d=this.hasHeader()?this.$thead[0]:null,f=this.hasFooter()?this.$tfoot[0]:null,p=this.hasCheckbox(),v=i.index,g=i.addedCount,b=i.removed,$=[],m=[],y=[],C=this.$data,x=this.$columns,E=b.length,N=E>0||g>0;N&&this.isResizable()&&this.resize(),E>0&&(m.push.apply(m,e(c,b)),d&&$.push.apply($,e(d,b)),f&&y.push.apply(y,e(f,b)));var k=[],S=[],A=[];if(g>0){for(s=0;g>s;++s){h=v+s;var D=x.at(h);if(o(this,D),d){var T=q.theadCell(this,D,h);u=d.childNodes[0],k.push(n(u,T,p?h+1:h))}if(f){var z=q.tfootCell(this,D,h);u=f.childNodes[0],A.push(n(u,z,p?h+1:h))}}for(a=0,l=c.childNodes.length;l>a;++a){u=c.childNodes[a];var O=r.indexBy(u.childNodes,t),B=u.getAttribute(w),j=C.byKey(B);for(s=0;g>s;++s){h=v+s;var W=x.at(h),F=W.id;O[F]&&u.removeChild(O[F]);var P=q.tbodyCell(this,j,x.at(h),h);S.push(n(u,P,p?h+1:h))}}}if(N){var R=this.isEditable();g>0&&R?I.bindEdition(this):E>0&&!R&&I.unbindEdition(this),this.dispatchEvent("columnsspliced",{index:v,removedNodes:{thead:$,tbody:m,tfoot:y},addedNodes:{thead:k,tbody:S,tfoot:A}})}return this},onUpdate:function(t){var e=t.index,n=this.hasCheckbox()?e+1:e,i=this.$columns.at(e);o(this,i);var a=function(t){var e=[[],[]],o=this["$"+t];if(o){var a=o[0].childNodes,h=s.call(this,t,i,n),u=function(t,e,n){var i=h.call(this,e,n);return t[0].push(i.oldNode),t[1].push(i.newNode),t};e=r.reduce(a,u,e,this)}return e},h=r.map([T,z,D],a,this);return i.editable?I.bindEdition(this):this.isEditable()||I.unbindEdition(this),this.dispatchEvent("columnsupdated",{index:e,oldNodes:{thead:h[0][0],tfoot:h[1][0],tbody:h[2][0]},newNodes:{thead:h[0][1],tfoot:h[1][1],tbody:h[2][1]}}),this}};return a}(),G=function(){var t=function(t){return t.childNodes[0].childNodes[0]},e=function(t,e){t.checked=e},n={on:function(t){return r.forEach(t,function(t){var e="on"+B.capitalize(t.type),n=G[e];n&&n.call(this,t)},this),this},onSplice:function(n){var r,s,o,a=this.$tbody,h=this.$data,u=n.object,l=a[0],c=l.childNodes,d=n.index,f=n.removed,p=n.addedCount,v=f.length;if(v>0)for(var g=0;v>g;++g)r=h.indexOf(f[g]),r>=0&&(s=c[r],i(s).removeClass(y),this.hasCheckbox()&&(o=t(s),o&&e(o,!1)));if(p>0)for(var b=0;p>b;++b)r=h.indexOf(u.at(d+b)),s=c[r],i(s).addClass(y),this.hasCheckbox()&&(o=t(s),o&&e(o,!0));if(p>0||v>0){var $=p-v;if($&&this.hasCheckbox()){var m=u.length,C=this.isSelected(),x=m>0&&h.length!==m,w=this.hasHeader()?this.$thead[0]:null,E=this.hasFooter()?this.$tfoot[0]:null;if(w){var N=w.childNodes[0].childNodes[0],k=N.childNodes[0],S=N.childNodes[1];k.innerHTML=k.title=m,S.checked=C,S.indeterminate=x}if(E){var A=E.childNodes[0].childNodes[0],D=A.childNodes[1],T=A.childNodes[0];D.innerHTML=D.title=m,T.checked=C,T.indeterminate=x}}this.dispatchEvent("selectionchanged",function(){return{selection:this.$selection.toArray()}})}return this}};return n}(),Q=function(){var e=B.resultWith,n=function(t){var e=t||[];return r.isArray(e)||(e=[e]),r.map(e,function(t){var e=t.charAt(0);return e!==S&&e!==A?S+t:t})},s=function(t){var e="$"+t,n=this.$table;this[e]=i(j.byTagName(t,n[0])),this[e].length||(this[e]=i(j[t]())),n.append(this[e][0])},o=function(t){var e=this.options.events[t];e&&this.addEventListener(t.slice(2),this.options.events[t])},a=function(t,e){if(!(this instanceof a))return new a(t,e);var n=this.$table=i(t),h=n[0],u=this.options=e=e||{},l=a.options;r.forEach(r.keys(l),function(t){var e=u[t],n=l[t];if(r.isUndefined(e)){var i=B.toSpinalCase(t),s=h.getAttribute("data-waffle-"+i)||h.getAttribute("data-"+i)||h.getAttribute(i);s&&(e=u[t]=B.parse(s))}r.isObject(n)&&(r.isObject(e)||r.isUndefined(e))&&(e=u[t]=r.defaults(e||{},n)),r.isUndefined(e)&&(e=u[t]=n)}),u.size={width:u.size.width,height:u.size.height},u.scrollable=u.scrollable||!!u.size.height,this.$data=new R(u.data,{key:u.key,model:u.model});var d=this.isSortable(),f=this.isDraggable();!u.columns||d&&!f||r.forEach(u.columns,function(t){d||(t.sortable=!1),f&&(t.draggable=null==t.draggable?!0:!!t.draggable)}),this.$columns=new R(u.columns,{key:"id",model:M});var p=u.scrollable,v=this.isSelectable(),g=this.isEditable();this.$sortBy=[],n.addClass(c),v&&n.addClass(m),p&&n.addClass($);var b=[D];u.view.thead&&b.unshift(T),u.view.tfoot&&b.push(z),r.forEach(b,s,this),this.$data.observe(K.on,this),this.$columns.observe(_.on,this),this.$$events={},d&&I.bindSort(this),g&&I.bindEdition(this),v&&(this.$selection=new R([],this.$data.options()),this.$selection.observe(G.on,this),I.bindSelection(this)),this.$bus=new F,r.forEach(r.keys(u.events),o,this),this.isResizable()&&(this.resize(),I.bindResize(this)),this.renderHeader().renderFooter().sortBy(e.sortBy,!1).renderBody(),this.clearChanges(),f&&I.bindDragDrop(this),this.dispatchEvent("initialized")};return a.create=function(t,e){return new a(t,e)},a.prototype={data:function(){return this.$data},columns:function(){return this.$columns},selection:function(){return this.$selection},isEditable:function(){return this.options.editable||this.$columns.some(function(t){return t.isEditable()})},isSortable:function(){return this.options.sortable},isSelectable:function(t){var n=this.options.selection;return n&&n.enable?t?e(n.enable,this,[t]):!0:!1},isResizable:function(){var t=this.options.size;return!!t.height||!!t.width},hasCheckbox:function(){return this.isSelectable()&&this.options.selection.checkbox},hasHeader:function(){return!!this.$thead},hasFooter:function(){return!!this.$tfoot},isSelected:function(t){if(!this.isSelectable())return!1;if(t)return this.$selection.contains(t);var e=this.$selection.length;if(0===e)return!1;var n=this.$data.length;return r.isFunction(this.options.selection.enable)&&(n=this.$data.filter(this.isSelectable,this).length),e>=n},isDraggable:function(){return!!this.options.dnd},render:function(){return this.renderHeader().renderFooter().renderBody().clearChanges()},renderHeader:function(){if(this.hasHeader()){var t=q.theadRow(this);this.$thead.empty().append(t)}return this},renderFooter:function(){if(this.hasFooter()){var t=q.tfootRow(this);this.$tfoot.empty().append(t)}return this},renderBody:function(t){var e=null==t?this.options.async:t,n=this,i=r.once(function(){n.$tbody.empty()}),s=function(t,e){var r=q.tbodyRows(n,t,e);i(),n.$tbody.append(r)},o=function(){n.$data.clearChanges(),n.dispatchEvent("rendered",function(){return{data:this.$data,nodes:r.toArray(this.$tbody[0].childNodes)}}),n=i=s=o=null};return e?B.asyncTask(this.$data.split(200),10,s,o):(s(this.$data,0),o()),this},resize:function(){return V.resize(this),this},select:function(){return this.$selection.length!==this.$data.length&&this.$selection.add(this.$data.filter(this.isSelectable,this)),this},deselect:function(){return this.$selection.isEmpty()||this.$selection.clear(),
this},sortBy:function(t,e){var i=n(t);if(this.$sortBy===i||this.$sortBy.join()===i.join())return this;this.$sortBy=i;var s=this.hasHeader(),o=this.hasFooter(),a=s?this.$thead.children().eq(0).children():null,u=o?this.$tfoot.children().eq(0).children():null,l=function(t){t.removeClass(f+" "+p).removeAttr(N)},c=function(t,e,n,i){t.eq(e).addClass(n?f:p).attr(N,i)};a&&l(a),u&&l(u);var d=this.$columns,v=this.hasCheckbox(),g=r.map(this.$sortBy,function(t){var e,n=t.charAt(0),i=t.substr(1),r=n===S,s=d.indexOf(i),o=v?s+1:s;return s>=0?(e=d.at(s),e.asc=r,a&&c(a,o,r,n),u&&c(u,o,r,n)):e={},{parser:e.$parser||h(t),fn:e.$comparator||U.$auto,desc:!r}});return this.$data.sort(H(g)),e!==!1&&this.renderBody(),this.dispatchEvent("sorted")},dispatchEvent:function(t,e){return this.$bus.dispatchEvent(this,t,e),this.$bus.dispatchEvent(this,"updated"),this},addEventListener:function(t,e){return this.$bus.addEventListener(t,e),this},removeEventListener:function(t,e){return this.$bus.removeEventListener(t,e),this},clearChanges:function(){return this.$data.clearChanges(),this.$columns.clearChanges(),this.$selection&&this.$selection.clearChanges(),this},destroy:function(){this.$table.off(),this.$tbody.off(),this.hasHeader()&&this.$thead.off(),this.hasFooter()&&this.$tfoot.off(),this.$$events.onResize&&i(t).off("resize",this.$$events.onResize),this.clearChanges(),this.$data.unobserve(),this.$columns.unobserve(),this.$selection.unobserve(),this.$bus.clear(),this.$$events=null,B.destroy(this)}},a.options={key:"id",data:null,columns:null,sortBy:null,async:!1,scrollable:!1,sortable:!0,editable:!1,dnd:!1,selection:{enable:!0,checkbox:!0,multi:!1},view:{thead:!0,tfoot:!1},size:{width:null,height:null},events:{}},r.forEach(["onInitialized","onUpdated","onRendered","onDataSpliced","onDataChanged","onDataUpdated","onColumnsSpliced","onColumnsUpdated","onSelectionChanged","onSorted"],function(t){a.options.events[t]=null}),a}(),Y={Grid:Q,addRenderer:function(t,e){return L[t]=e,Y},addComparator:function(t,e){return U[t]=e,Y}},X="wafflejs";i.fn.waffle=function(t){var e=this,n=[e].concat(r.rest(arguments));return r.isUndefined(t)||r.isObject(t)?this.each(function(){var e=i(this),n=e.data(X);n||(n=new Q(this,t),e.data(X,n),e.on("waffleDestroyed",function(){var t=i(this);t.data(X).destroy(),t.removeData(X).off()}))}):r.isString(t)&&(e=i.fn.waffle[t].apply(null,n)||e),e},i.fn.waffle.options={},i.event.special.waffleDestroyed={add:function(t){t.handler&&(t.handler=r.bind(t.handler,this))},remove:function(t){t.handler&&t.handler(t)}};var Z=r.filter(r.functions(Q.prototype),function(t){return"$"!==t.charAt(0)});return r.forEach(Z,function(t){i.fn.waffle[t]=function(e){var n=r.rest(arguments),s=[];return e.each(function(){var r=i(this),o=r.data(X);if(o){var a=o[t].apply(o,n),h=a instanceof Q?e:a;h===e?s[0]=h:s.push(h)}}),1===s.length?s[0]:s}}),r.forEach(r.functions(Y),function(t){i.fn.waffle[t]=Y[t]}),i.fn.waffle.options=Q.options,Y})}(window,document,void 0);