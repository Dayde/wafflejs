!function(t,n,e){!function(n){"function"==typeof define&&define.amd?define(["jquery","underscore"],n):"object"==typeof exports?module.exports=n(require("jquery"),require("underscore")):t.Waffle=n(jQuery,_)}(function(t,r){"use strict";var i=function(t){var n=i.$split(t),s=n.length;return function(t){for(var i=t,o=0;s>o;++o){if(null==i||!r.isObject(i))return e;i=r.result(i,n[o])}return i}};i.$normalize=function(t){for(var n=[],e=t.split("."),r=/(.+?)?(\[(\d+)\])/,i=/(.+?)?(\['(.+)'\])/,s=/(.+?)?(\["(.+)"\])/,o=function(t,n,e,r){var i=n?n+".":"";return i+r},a=0,u=e.length;u>a;++a){var h=e[a].replace(r,o).replace(i,o).replace(s,o),c=h.indexOf("(");c>0&&(h=h.slice(0,c)),n[a]=h}return n.join(".")},i.$split=function(t){return i.$normalize(t).split(".")};var s=function(t){var e=n.createElement("div");return e.appendChild(n.createTextNode(t)),e.innerHTML},o="waffle-",a=o+"sortable",u=a+"-asc",h=a+"-desc",c=o+"fixedheader",l="data-waffle-",f=l+"id",d=l+"sortable",$=l+"order",p="+",v="-",y=function(){var t="key_",n=function(n){return t+n},e=function(){return this instanceof e?void(this.$o={}):new e};return e.prototype={clear:function(){this.$o={}},put:function(t,e){return this.$o[n(t)]=e,this},get:function(t){return this.$o[n(t)]},remove:function(t){return delete this.$o[n(t)],this},contains:function(t){return r.has(this.$o,n(t))}},e}(),g=function(){var t=function(){var t=n.createElement("div");t.style.width="100px",t.style.height="100px",t.style.overflow="scroll",t.style.position="absolute",t.style.top="-9999px",n.body.appendChild(t);var e=t.offsetWidth-t.clientWidth;return n.body.removeChild(t),e},e=function(){return"body"},i={create:function(t){return n.createElement(t)},byId:function(t){var e=n.getElementById(t);return e?[e]:[]},byTagName:function(t,e){return(e||n).getElementsByTagName(t)},createFragment:function(){return n.createDocumentFragment()},scrollbarWidth:r.memoize(t,e)};return r.forEach(["tr","td","th","tbody","thead"],function(t){i[t]=function(){return this.create(t)}}),i}(),m={toPx:function(t){return r.isNumber(t)?t+"px":t},fromPx:function(t){return r.isString(t)?Number(t.replace("px","")):t}},b=function(){var t=Array.prototype,n=function(){try{var n={};return n[0]=1,!!t.toString.call(n)}catch(e){return!1}}(),s=function(e){return function(){var i=n?this:r.toArray(this);return t[e].apply(i,arguments)}},o=function(t,n,e){return s(t).apply(n,e)},a=function(t,n){this.$$map=new y;var e=n||{};this.$$key=e.key||"id",this.$$model=e.model||Object,r.isFunction(this.$$key)||(this.$$key=i(this.$$key)),this.$$observers=[],this.$$changes=[],this.length=0,t&&t.length&&this.push.apply(this,t)},u=function(t){return parseInt(Number(t)||0,10)},h="splice",c="update",l=function(t,n,e,r,i){return{type:t,removed:n,index:e,addedCount:r,object:i}},f=function(t,n){delete t[n]},d=function(t,n){t.$$map.remove(n)},$=function(t,n){var e=t.$$key(n),r=t.$$map.get(e);null!=r&&(f(t,r),d(t,e))},p=function(t,n){if(!r.isObject(n))throw new Error("Waffle collections are not array, only object are allowed");return n instanceof t.$$model?n:new t.$$model(n)},v=function(t,n,e){t[e]=n,null!=n&&t.$$map.put(t.$$key(n),e)},g=function(t,n,e){var r=t.at(e),i=t.at(n);v(t,i,e),v(t,r,n)},m=function(t,n,e){for(var r=Math.abs(e),i=t.length-1;i>=n;--i)g(t,i,i+r);t.length+=r},b=function(t,n,e){for(var r=Math.abs(e),i=t.length,s=i-r,o=n+r,a=[],u=o;i>u;++u)g(t,u,u-r);for(var h=s;i>h;++h){var c=t.at(h);a.unshift(c),$(t,c)}return t.length=s,a},w=function(t,n){for(var e,i=t.$$sortFn,s=t.length,o=n.length,a=s+o,u=[],c=s-1,f=o-1,d=a-1;d>=0;--d)if(0>c||i(t[c],n[f])<0){if(v(t,n[f--],d),e=r.first(u),e&&e.index===d+1?(e.index=d,e.addedCount++):(e=l(h,[],d,1,t),u.unshift(e)),0>f)break}else v(t,t[c--],d);return t.length=a,u},x=function(t){t.callback.call(t.ctx,this.$$changes)};return a.prototype={at:function(t){return this[t]},byKey:function(t){var n=this.indexByKey(t);return n>=0?this.at(n):e},indexByKey:function(t){return this.$$map.contains(t)?this.$$map.get(t):-1},findIndex:function(t,n){for(var e=0,r=this.length;r>e;++e)if(t.call(n,this.at(e),e,this))return e;return-1},add:function(t,n){var e=[t,0].concat(n);return this.splice.apply(this,e),this.length},remove:function(t,n){return this.splice.call(this,t,n)},push:function(){return this.add.call(this,this.length,r.toArray(arguments))},unshift:function(){return this.add.call(this,0,r.toArray(arguments))},pop:function(){return this.remove(this.length-1,1)[0]},shift:function(){return this.remove(0,1)[0]},clear:function(){if(this.length>0){for(var t=[],n=0,e=this.length;e>n;++n)t[n]=this.at(n),f(this,n);this.$$map.clear(),this.length=0,this.trigger(l(h,t,0,0,this))}return this},reset:function(t){var n=this.length,e=t.length,r=this.$$sortFn;r&&t.sort(r),this.$$map.clear();for(var i=[],s=t.length,o=0;e>o;++o)n>o&&i.push(this.at(o)),v(this,p(this,t[o]),o);for(;n>o;++o)i.push(this.at(o)),f(this,o);return this.length=e,this.trigger([l(h,i,0,s,this)]),this},isEmpty:function(){return 0===this.length},concat:function(){var n=t.concat.apply(this.toArray(),arguments);return new a(n,{key:this.$$key,model:this.$$model})},slice:function(){var t=o("slice",this,arguments);return new a(t,{key:this.$$key,model:this.$$model})},splice:function(t,n){var e=this.$$sortFn,i=this.length,s=r.rest(arguments,2),o=function(t){return p(this,t)},a=r.map(s,o,this),c=a.length,f=u(t);f=f>=0?Math.min(i,f):Math.max(i+f,0);var d=Math.min(Math.max(u(n)||0,0),i-f),$=[];if(d>0){for(var y=0;d>y;++y)$.push(this[y+f]);b(this,f,d)}var g;if(c>0)if(e)a.sort(e),g=w(this,a);else{m(this,f,c);for(var x=0;c>x;++x)v(this,a[x],f+x);g=[l(h,$,f,c,this)]}else g=[];if($.length>0){var C=r.find(g,function(t){return t.index===f});C?C.removed=$:g.unshift(l(h,$,f,0,this))}return g&&g.length>0&&this.trigger(g),$},reverse:function(){if(this.$$sortFn)return this;for(var t=this.length,n=Math.floor(t/2),e=[],r=[],i=0,s=t-1;n>i;++i,--s)g(this,i,s),e.push(l(c,[],i,0,this)),r.unshift(l(c,[],s,0,this));var o=e.concat(r);return o.length&&this.trigger(o),this},split:function(t){for(var n=t||20,e=[],r=[],i=0,s=this.length;s>i;++i)r.push(this.at(i)),r.length===n&&(e.push(r),r=[]);return r.length>0&&e.push(r),e},toJSON:function(){return JSON.stringify(this.toArray())},sort:function(t){return this.$$sortFn=t,this.reset(this.toArray()).clearChanges()},pluck:function(t){return this.map(i(t))},observe:function(t,n){return this.$$observers.push({ctx:n||null,callback:t}),this},unobserve:function(t,n){if(0===arguments.length)this.$$observers=[];else{var e=n||null;this.$$observers=r.reject(this.$$observers,function(n){return n.ctx===e&&t===n.callback})}return this},trigger:function(t){this.$$changes=this.$$changes.concat(t);var n=this;return setTimeout(function(){n.$$changes.length>0&&(r.forEach(n.$$observers,x,n),n.$$changes=[]),n=null}),this},clearChanges:function(){return this.$$changes=[],this}},r.forEach(["indexOf","size","lastIndexOf","first","last","initial","rest","partition","forEach","map","every","some","reduce","reduceRight","filter","reject","find","toArray"],function(t){r[t]&&(a.prototype[t]=function(){var n=[this].concat(r.toArray(arguments));return r[t].apply(r,n)})}),r.forEach(["countBy","groupBy","indexBy"],function(t){a.prototype[t]=function(n,e){return r.isString(n)&&(n=i(n)),r[t].call(r,this,n,e)}}),r.forEach(["toString","toLocaleString","join"],function(t){a.prototype[t]=s(t)}),a}(),w=function(){var t=function(t){return(null==t?"":t).toString()},n={$identity:r.identity,$empty:function(){return""},$lowercase:function(n){return t(n).toLowerCase()},$uppercase:function(n){return t(n).toUpperCase()},$capitalize:function(n){var e=t(n);return e.charAt(0).toUpperCase()+e.slice(1)},$get:function(t){return n[t]}};return n}(),x={$string:function(t,n){var e=null==t?"":String(t),r=null==n?"":String(n);return e.localeCompare(r)},$number:function(t,n){var e=null==t?0:Number(t),r=null==n?0:Number(n);return e-r},$boolean:function(t,n){var e="false"===t?0:Boolean(t)?1:0,r="false"===n?0:Boolean(n)?1:0;return e-r},$date:function(t,n){var e=new Date(null==t?0:t).getTime(),r=new Date(null==n?0:n).getTime();return e-r},$auto:function(t,n){if(t===n||null==t&&null==n)return 0;var e=r.find(["Number","Boolean","Date","String"],function(e){var i=r["is"+e];return i(t)||i(n)});return e?x["$"+e.toLowerCase()](t,n):n>t?-1:1},$get:function(t){return x[t]}},C=function(t){return r.isArray(t)||(t=[t]),function(n,e){if(n===e||null==n&&null==e)return 0;for(var r=0,i=t.length;i>r;++r){var s=t[r],o=s.parser(n),a=s.parser(e),u=s.fn.call(x,o,a);if(u)return s.desc?-1*u:u}return 0}},B=function(){var t=r.isUndefined,n="$identity",e="$auto",o=m.fromPx,c=m.toPx,l=function(t,n,e){return r.isString(t)&&(t=n.$get(t)),r.isFunction(t)||(t=n.$get(e)),t},y=function(a){var u=a.escape,h=a.sortable;this.id=a.id,this.title=a.title||"",this.field=a.field||this.id,this.css=a.css||this.id,this.escape=t(u)?!0:!!u,this.width=o(a.width),this.sortable=t(h)?!0:!!h,this.asc=t(a.asc)?null:!!a.asc,u&&(this.title=s(this.title));var c=a.renderer||n,f=r.isArray(c)?c:[c];this.$renderer=r.map(f,function(t){return l(t,w,n)}),this.$comparator=l(a.comparator,x,e),this.$parser=i(this.field)};return y.prototype={cssClasses:function(){var t=[this.css];this.sortable&&t.push(a);var n=this.asc;return null!=n&&t.push(n?u:h),t.join(" ")},attributes:function(t,n){var e={};if(e[f]=this.id,n&&this.sortable){e[d]=!0;var r=this.asc;null!=r&&(e[$]=r?p:v)}return e},styles:function(){var t={},n=c(this.width);return n&&(t.width=n,t.maxWidth=n,t.minWidth=n),t},updateWidth:function(t){return this.width=o(t),this},render:function(t){var n=this.field,e=null==t?"":this.$parser(t),i=r.reduce(this.$renderer,function(e,r){return r.call(w,e,t,n)},e);return null==i?"":this.escape?s(i):i}},y}(),A=function(){var n=m.toPx,e=m.fromPx,s=function(t){var n=t||[];return r.isArray(n)||(n=[n]),r.map(n,function(t){var n=t.charAt(0);return n!==p&&n!==v?p+t:t})},o=function(t,n,e){var i=t.options.events[n];return i!==r.noop&&i.apply(t,(e||r.noop).call(t)),t},a=function(n){var e=n.$table[0];if(n.$tbody=t(g.byTagName("tbody",e)),n.$thead=t(g.byTagName("thead",e)),!n.$thead.length){var r=g.thead();n.$thead=t(r),n.$table.append(r)}if(!n.$tbody.length){var i=g.tbody();n.$tbody=t(i),n.$table.append(i)}return n},l=function(n,e){var r=g.tr();return n.$columns.forEach(function(n,i){var s=t(g.td()).addClass(n.cssClasses(i,!1)).css(n.styles(i,!1)).attr(n.attributes(i,!1)).html(n.render(e));r.appendChild(s[0])}),r},y=function(n,i){if(!(this instanceof y))return new y(n,i);r.defaults(i.events||{},y.options.events),this.options=r.defaults(i||{},y.options),this.$table=t(n),this.$data=new b(i.data||[],{key:i.key}),this.$columns=new b(i.columns||[],{key:"id",model:B});var s=i.size;this.options.size={width:e(s.width),height:e(s.height)},this.$sortBy=[],a(this),this.$$bind().$$observe().assignWidth().renderHeader().sortBy(i.sortBy,!1).renderBody(),o(this,"onInitialized")};return y.create=function(t,n){return new y(t,n)},y.prototype={data:function(){return this.$data},columns:function(){return this.$columns},render:function(){return this.renderHeader().renderBody()},assignWidth:function(){var t=this.options.size,e=t.width;if(t.height){var r=n(t.width);this.$table.addClass(c).css({width:r,maxWidth:r,minWidth:r}),this.$tbody.css({maxHeight:n(t.height)}),e-=g.scrollbarWidth()}var i=0,s=0;this.$columns.forEach(function(t){var n=t.width;n&&(i+=n,++s)});var o=this.$columns.length,a=o-s,u=0,h=0;if(a){var l=(e-i)/a;u=Math.floor(l),h=l-u}var f=0;return this.$columns.forEach(function(t){var n=t.width,e=n||0;e||(f+=h,f>=1?(e=u+1,f--):e=u),e!==n&&t.updateWidth(e)}),this},renderHeader:function(){var n=g.tr();return this.$columns.forEach(function(e,r,i){var s=t(g.th()).addClass(e.cssClasses(r,!0)).css(e.styles(r,!0)).attr(e.attributes(r,i,!0)).html(e.title);n.appendChild(s[0])}),this.$thead.empty().append(n),this},renderBody:function(t){var n=null==t?this.options.async:t,e=this,i=function(t,n){for(var e=g.createFragment(),r=0,i=n.length;i>r;++r){var s=l(t,n[r]);e.appendChild(s)}return e},s=function(t){t.$data.clearChanges(),o(t,"onRendered",function(){return[this.$data,r.toArray(this.$tbody[0].childNodes)]}),t=i=s=null};if(n){var a=10,u=this.$data.split(200),h=function(){if(u.length>0){var t=i(e,u.shift());e.$tbody.append(t),setTimeout(h,a)}else s(e),h=u=null};this.$tbody.empty(),setTimeout(h)}else{var c=i(e,e.data());e.$tbody.empty().append(c),s(e)}return this},sortBy:function(t,n){var e=s(t);if(this.$sortBy===e||this.$sortBy.join()===e.join())return this;this.$sortBy=e;var a=this.$thead.children().eq(0),c=a.children();c.removeClass(u+" "+h).removeAttr($);var l=this.$columns,f=r.map(this.$sortBy,function(t){var n,e=t.charAt(0),r=t.substr(1),s=e===p,o=l.indexByKey(r);return o>=0?(n=l.at(o),n.asc=s,c.eq(o).addClass(s?u:h).attr($,e)):n={},{parser:n.$parser||i(t),fn:n.$comparator||x.$auto,desc:!s}});return this.$data.sort(C(f)),n!==!1&&this.renderBody(),o(this,"onSorted")},destroy:function(){return this.$$unbind().$$unobserve().$$destroy()},$$destroy:function(){for(var t in this)this.hasOwnProperty(t)&&(this[t]=null);return this},$$bind:function(){var t=this;return this.$thead.on("click",function(n){var e=n.target;if(e.getAttribute(d)){var r,i=e.getAttribute(f),s=e.getAttribute($)||v,o=s===p?v:p,a=o+i;if(n.shiftKey){r=t.$sortBy.slice();var u=s+i,h=r.indexOf(u);h>=0&&r.splice(h,1),r.push(a)}else r=[a];t.sortBy(r)}}),this},$$unbind:function(){return this.$thead.off(),this},$$observe:function(){return this.$data.observe(this.$$onDataChange,this),this},$$unobserve:function(){return this.$data.unobserve(),this},$$onDataChange:function(t){return r.forEach(t,function(t){var n=t.type,e="$$on_"+n;this[e](t)},this),this},$$on_splice:function(t){var n=t.index,e=t.addedCount,i=t.object,s=t.removed.length;if(s>0){var a;if(0===n&&s===this.$tbody[0].childNodes.length)a=r.toArray(this.$tbody[0].childNodes),this.$tbody.empty();else{a=[];for(var u=0;s>u;++u){var h=u+n,c=this.$tbody.children().eq(h);a.push(c[0]),c.remove()}}o(this,"onRemoved",function(){return[t.removed,a,n]})}if(e>0){for(var f=g.createFragment(),d=[],$=[],p=0;e>p;++p){var v=p+n,y=i.at(v),m=l(this,y);$.push(m),d.push(y),f.appendChild(m)}n>0?this.$tbody.children().eq(n-1).after(f):this.$tbody.prepend(f),o(this,"onAdded",function(){return[d,$,n]})}return this},$$on_update:function(t){var n=t.index,e=this.$data.at(n),r=this.$tbody[0],i=r.childNodes[n],s=l(this,e);return r.replaceChild(s,i),this}},y.options={key:"id",async:!1,size:{width:null,height:null},events:{}},r.forEach(["onInitialized","onRendered","onAdded","onRemoved","onSorted"],function(t){y.options.events[t]=r.noop}),y}(),k={Grid:A,addRenderer:function(t,n){return w[t]=n,k},addComparator:function(t,n){return x[t]=n,k}},E="wafflejs";t.fn.waffle=function(n){var e=this,i=[e].concat(r.rest(arguments));return r.isUndefined(n)||r.isObject(n)?this.each(function(){var e=t(this),i=e.data(E);if(!i){var s=t.extend({},t.fn.waffle.options);r.isObject(n)&&(s=t.extend(s,n)),i=new A(this,s),e.data(E,i),e.on("waffleDestroyed",function(){var n=t(this);n.data(E).destroy(),n.removeData(E).off()})}}):r.isString(n)&&(e=t.fn.waffle[n].apply(null,i)||e),e},t.fn.waffle.options={},t.event.special.waffleDestroyed={add:function(t){t.handler&&(t.handler=r.bind(t.handler,this))},remove:function(t){t.handler&&t.handler(t)}};var j=r.filter(r.functions(A.prototype),function(t){return"$"!==t.charAt(0)});return r.forEach(j,function(n){t.fn.waffle[n]=function(e){var i=r.rest(arguments),s=[];return e.each(function(){var r=t(this),o=r.data(E);if(o){var a=o[n].apply(o,i),u=a instanceof A?e:a;u===e?s[0]=u:s.push(u)}}),1===s.length?s[0]:s}}),r.forEach(r.functions(k),function(n){t.fn.waffle[n]=k[n]}),t.fn.waffle.options=A.options,k})}(window,document,void 0);